
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>13. Survival analysis &#8212; Think Stats</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=3ee479438cf8b5e0d341" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=3ee479438cf8b5e0d341" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=3ee479438cf8b5e0d341" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=3ee479438cf8b5e0d341" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css?v=a3416100" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css?v=be8a1c11" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-design.min.css?v=87e54e7c" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=3ee479438cf8b5e0d341" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=3ee479438cf8b5e0d341" />
  <script src="_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=3ee479438cf8b5e0d341"></script>

    <script src="_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js?v=36754332"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]]}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'chap13';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="14. Analytic methods" href="chap14.html" />
    <link rel="prev" title="12. Time series analysis" href="chap12.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="index.html">
  
  
  
  
  
  
    <p class="title logo__title">Think Stats</p>
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="index.html">
                    Think Stats, 3rd edition
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Front Matter</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="chap00.html">Preface</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Chapters</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="chap01.html">1. Exploratory Data Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap02.html">2. Distributions</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap03.html">3. Probability Mass Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap04.html">4. Cumulative Distribution Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap05.html">5. Modeling Distributions</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap06.html">6. Probability Density Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap07.html">7. Relationships between variables</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap08.html">8. Estimation</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap09.html">9. Hypothesis Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap10.html">10. Least Squares</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap11.html">11. Regression</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap12.html">12. Time series analysis</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">13. Survival analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap14.html">14. Analytic methods</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Examples</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="ripoff_etf.html">Rip-off ETF?</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">


<a href="https://github.com/AllenDowney/ThinkStats/tree/v3" target="_blank"
   class="btn btn-sm btn-source-repository-button"
   title="Source repository"
   data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>

</a>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/chap13.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Survival analysis</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#survival-function">13.1. Survival Function</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#hazard-function">13.2. Hazard Function</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#marriage-data">13.3. Marriage Data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#weighted-resampling">13.4. Weighted Resampling</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#estimating-survival-functions">13.5. Estimating Survival Functions</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#estimating-the-survival-function">13.6. Estimating the Survival Function</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#lifelines">13.7. Lifelines</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#confidence-intervals">13.8. Confidence Intervals</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#expected-remaining-lifetime">13.9. Expected remaining lifetime</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#glossary">13.10. Glossary</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercises">13.11. Exercises</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise">13.11.1. Exercise</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">13.11.2. Exercise</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="survival-analysis">
<h1><span class="section-number">13. </span>Survival analysis<a class="headerlink" href="#survival-analysis" title="Link to this heading">#</a></h1>
<p><strong>Survival analysis</strong> is a way to describe how long things last.
It is often used to study human lifetimes, but it also applies to “survival” of mechanical and electronic components, or more generally to an interval in time before any kind of event – or an interval in space.</p>
<p>If someone you know has been diagnosed with a life-threatening disease, you might have seen a “5-year survival rate,” which is the probability of surviving five years after diagnosis.
This chapter introduces the tools and methods used to produce estimates like that.</p>
<p>We’ll start with a relatively simple example, the lifespans of light bulbs, and then consider a more substantial example, age at first marriage and how it has changed in the United States over the last 50 years.</p>
<p><a class="reference external" href="https://colab.research.google.com/github/AllenDowney/ThinkStats/blob/v3/nb/chap13.ipynb">Click here to run this notebook on Colab</a>.</p>
<div class="cell tag_remove-print tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> nb_black
<span class="o">%</span><span class="k">load_ext</span> autoreload
<span class="o">%</span><span class="k">autoreload</span> 2
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 1;
                var nbb_unformatted_code = "%load_ext nb_black\n%load_ext autoreload\n%autoreload 2";
                var nbb_formatted_code = "%load_ext nb_black\n%load_ext autoreload\n%autoreload 2";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</details>
</div>
<div class="cell tag_remove-print tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">basename</span><span class="p">,</span> <span class="n">exists</span>


<span class="k">def</span> <span class="nf">download</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">basename</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">urllib.request</span> <span class="kn">import</span> <span class="n">urlretrieve</span>

        <span class="n">local</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">urlretrieve</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Downloaded &quot;</span> <span class="o">+</span> <span class="n">local</span><span class="p">)</span>


<span class="n">download</span><span class="p">(</span><span class="s2">&quot;https://github.com/AllenDowney/ThinkStats/raw/v3/nb/thinkstats.py&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 2;
                var nbb_unformatted_code = "from os.path import basename, exists\n\n\ndef download(url):\n    filename = basename(url)\n    if not exists(filename):\n        from urllib.request import urlretrieve\n\n        local, _ = urlretrieve(url, filename)\n        print(\"Downloaded \" + local)\n\n\ndownload(\"https://github.com/AllenDowney/ThinkStats/raw/v3/nb/thinkstats.py\")";
                var nbb_formatted_code = "from os.path import basename, exists\n\n\ndef download(url):\n    filename = basename(url)\n    if not exists(filename):\n        from urllib.request import urlretrieve\n\n        local, _ = urlretrieve(url, filename)\n        print(\"Downloaded \" + local)\n\n\ndownload(\"https://github.com/AllenDowney/ThinkStats/raw/v3/nb/thinkstats.py\")";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</details>
</div>
<div class="cell tag_remove-print tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">empiricaldist</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="o">!</span>pip<span class="w"> </span>install<span class="w"> </span>empiricaldist
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 3;
                var nbb_unformatted_code = "try:\n    import empiricaldist\nexcept ImportError:\n    !pip install empiricaldist";
                var nbb_formatted_code = "try:\n    import empiricaldist\nexcept ImportError:\n    !pip install empiricaldist";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</details>
</div>
<div class="cell tag_remove-print tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="kn">from</span> <span class="nn">thinkstats</span> <span class="kn">import</span> <span class="n">decorate</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 4;
                var nbb_unformatted_code = "import numpy as np\nimport pandas as pd\nimport matplotlib.pyplot as plt\n\nfrom thinkstats import decorate";
                var nbb_formatted_code = "import numpy as np\nimport pandas as pd\nimport matplotlib.pyplot as plt\n\nfrom thinkstats import decorate";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</details>
</div>
<section id="survival-function">
<h2><span class="section-number">13.1. </span>Survival Function<a class="headerlink" href="#survival-function" title="Link to this heading">#</a></h2>
<p>A fundamental concept in survival analysis is the <strong>survival function</strong> which is the fraction of a population that survives longer than a given duration.
As a first example, we’ll compute a survival function for the lifespans of light bulbs.</p>
<p>We’ll use data from an experiment conducted in 2007 – researchers installed 50 new light bulbs and left them on continuously.
Checking on the bulbs every 12 hours, they recorded the lifespan of all 50 bulbs.
Instructions for downloading the data are in the notebook for this chapter.</p>
<p>The following cell downloads the data, which is documented <a class="reference external" href="https://gist.github.com/epogrebnyak/7933e16c0ad215742c4c104be4fbdeb1">here</a>.</p>
<p>Dataset from:</p>
<p>V.J. Menon and D.C. Agrawal,  Renewal Rate of Filament Lamps:
Theory and Experiment. Journal of Failure Analysis and Prevention.
December 2007, p. 421, Table 2/
DOI: 10.1007/s11668-007-9074-9</p>
<div class="cell tag_remove-print docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">download</span><span class="p">(</span>
    <span class="s2">&quot;https://gist.github.com/epogrebnyak/7933e16c0ad215742c4c104be4fbdeb1/raw/c932bc5b6aa6317770c4cbf43eb591511fec08f9/lamps.csv&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 5;
                var nbb_unformatted_code = "download(\n    \"https://gist.github.com/epogrebnyak/7933e16c0ad215742c4c104be4fbdeb1/raw/c932bc5b6aa6317770c4cbf43eb591511fec08f9/lamps.csv\"\n)";
                var nbb_formatted_code = "download(\n    \"https://gist.github.com/epogrebnyak/7933e16c0ad215742c4c104be4fbdeb1/raw/c932bc5b6aa6317770c4cbf43eb591511fec08f9/lamps.csv\"\n)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>We can read the data like this.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;lamps.csv&quot;</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">tail</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>h</th>
      <th>f</th>
      <th>K</th>
    </tr>
    <tr>
      <th>i</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>28</th>
      <td>1812</td>
      <td>1</td>
      <td>4</td>
    </tr>
    <tr>
      <th>29</th>
      <td>1836</td>
      <td>1</td>
      <td>3</td>
    </tr>
    <tr>
      <th>30</th>
      <td>1860</td>
      <td>1</td>
      <td>2</td>
    </tr>
    <tr>
      <th>31</th>
      <td>1980</td>
      <td>1</td>
      <td>1</td>
    </tr>
    <tr>
      <th>32</th>
      <td>2568</td>
      <td>1</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div></div><script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 6;
                var nbb_unformatted_code = "df = pd.read_csv(\"lamps.csv\", index_col=0)\ndf.tail()";
                var nbb_formatted_code = "df = pd.read_csv(\"lamps.csv\", index_col=0)\ndf.tail()";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">h</span></code> column contains the lifespans in hours.
The <code class="docutils literal notranslate"><span class="pre">f</span></code> column contains counts of the number of bulbs that expired at each value of <code class="docutils literal notranslate"><span class="pre">h</span></code>.
To represent the distribution of lifespans, we’ll put these values in a <code class="docutils literal notranslate"><span class="pre">Pmf</span></code> object and normalize it.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">empiricaldist</span> <span class="kn">import</span> <span class="n">Pmf</span>

<span class="n">pmf_bulblife</span> <span class="o">=</span> <span class="n">Pmf</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;f&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;h&quot;</span><span class="p">])</span>
<span class="n">pmf_bulblife</span><span class="o">.</span><span class="n">normalize</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>50
</pre></div>
</div>
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 7;
                var nbb_unformatted_code = "from empiricaldist import Pmf\n\npmf_bulblife = Pmf(df[\"f\"].values, index=df[\"h\"])\npmf_bulblife.normalize()";
                var nbb_formatted_code = "from empiricaldist import Pmf\n\npmf_bulblife = Pmf(df[\"f\"].values, index=df[\"h\"])\npmf_bulblife.normalize()";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>We can use <code class="docutils literal notranslate"><span class="pre">make_cdf</span></code> to compute the CDF, which indicates the fraction of bulbs that expire at or before each value of <code class="docutils literal notranslate"><span class="pre">h</span></code>.
For example, 78% of the bulbs expire at or before 1656 hours.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cdf_bulblife</span> <span class="o">=</span> <span class="n">pmf_bulblife</span><span class="o">.</span><span class="n">make_cdf</span><span class="p">()</span>
<span class="n">cdf_bulblife</span><span class="p">[</span><span class="mi">1656</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.7800000000000002
</pre></div>
</div>
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 8;
                var nbb_unformatted_code = "cdf_bulblife = pmf_bulblife.make_cdf()\ncdf_bulblife[1656]";
                var nbb_formatted_code = "cdf_bulblife = pmf_bulblife.make_cdf()\ncdf_bulblife[1656]";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>The survival function is fraction of bulbs that expire <em>after</em> each value of <code class="docutils literal notranslate"><span class="pre">h</span></code>, which is the complement of the CDF.
So we can compute it like this.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">complementary_cdf</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">cdf_bulblife</span>
<span class="n">complementary_cdf</span><span class="p">[</span><span class="mi">1656</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.21999999999999975
</pre></div>
</div>
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 9;
                var nbb_unformatted_code = "complementary_cdf = 1 - cdf_bulblife\ncomplementary_cdf[1656]";
                var nbb_formatted_code = "complementary_cdf = 1 - cdf_bulblife\ncomplementary_cdf[1656]";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>22% of the bulbs expire after 1656 hours.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">empiricaldist</span></code> library provides a <code class="docutils literal notranslate"><span class="pre">Surv</span></code> object that represents a survival function, and a method called <code class="docutils literal notranslate"><span class="pre">make_surv</span></code> that makes one.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">surv_bulblife</span> <span class="o">=</span> <span class="n">cdf_bulblife</span><span class="o">.</span><span class="n">make_surv</span><span class="p">()</span>
<span class="n">surv_bulblife</span><span class="p">[</span><span class="mi">1656</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.21999999999999997
</pre></div>
</div>
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 10;
                var nbb_unformatted_code = "surv_bulblife = cdf_bulblife.make_surv()\nsurv_bulblife[1656]";
                var nbb_formatted_code = "surv_bulblife = cdf_bulblife.make_surv()\nsurv_bulblife[1656]";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>If we plot the CDF and the survival function, we can see that they are complementary – that is, their sum is 1 at all values of <code class="docutils literal notranslate"><span class="pre">h</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cdf_bulblife</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ls</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;CDF&quot;</span><span class="p">)</span>
<span class="n">surv_bulblife</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;Survival&quot;</span><span class="p">)</span>

<span class="n">decorate</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;Light bulb duration (hours)&quot;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;Probability&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/ce2def220f0cdd5b99452be63e950324f4f516a25a357c1948542f61ad1f16f6.png" src="_images/ce2def220f0cdd5b99452be63e950324f4f516a25a357c1948542f61ad1f16f6.png" />
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 11;
                var nbb_unformatted_code = "cdf_bulblife.plot(ls=\"--\", label=\"CDF\")\nsurv_bulblife.plot(label=\"Survival\")\n\ndecorate(xlabel=\"Light bulb duration (hours)\", ylabel=\"Probability\")";
                var nbb_formatted_code = "cdf_bulblife.plot(ls=\"--\", label=\"CDF\")\nsurv_bulblife.plot(label=\"Survival\")\n\ndecorate(xlabel=\"Light bulb duration (hours)\", ylabel=\"Probability\")";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>In that sense, the CDF and survival function are equivalent – if we are given either one, we can compute the other.
But in the context of survival analysis it is more common to work with survival curves.
And computing a survival curve is a step toward the next important concept, the hazard function.</p>
</section>
<section id="hazard-function">
<h2><span class="section-number">13.2. </span>Hazard Function<a class="headerlink" href="#hazard-function" title="Link to this heading">#</a></h2>
<p>Suppose we know that a light bulb has survived up to hour <code class="docutils literal notranslate"><span class="pre">h</span></code>, and we would like to know the probability that it expires during hour <code class="docutils literal notranslate"><span class="pre">h</span></code>.
To answer this question, we can use the survival function, which indicates the fraction of bulbs that survive longer than <code class="docutils literal notranslate"><span class="pre">h</span></code>, and the PMF, which indicates the fraction that expire during hour <code class="docutils literal notranslate"><span class="pre">h</span></code>.
The sum of these is the fraction of bulbs that <em>could</em> expire during hour <code class="docutils literal notranslate"><span class="pre">h</span></code>, which are said to be “at risk”.
As an example, 26% of the bulbs were at risk during hour 1656.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">at_risk</span> <span class="o">=</span> <span class="n">pmf_bulblife</span> <span class="o">+</span> <span class="n">surv_bulblife</span>
<span class="n">at_risk</span><span class="p">[</span><span class="mi">1656</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.25999999999999995
</pre></div>
</div>
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 12;
                var nbb_unformatted_code = "at_risk = pmf_bulblife + surv_bulblife\nat_risk[1656]";
                var nbb_formatted_code = "at_risk = pmf_bulblife + surv_bulblife\nat_risk[1656]";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>And 4% of all bulbs expire during hour 1656.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pmf_bulblife</span><span class="p">[</span><span class="mi">1656</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.04
</pre></div>
</div>
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 13;
                var nbb_unformatted_code = "pmf_bulblife[1656]";
                var nbb_formatted_code = "pmf_bulblife[1656]";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>The <strong>hazard</strong> is the ratio of <code class="docutils literal notranslate"><span class="pre">pmf_bulblife</span></code> and <code class="docutils literal notranslate"><span class="pre">at_risk</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hazard</span> <span class="o">=</span> <span class="n">pmf_bulblife</span> <span class="o">/</span> <span class="n">at_risk</span>
<span class="n">hazard</span><span class="p">[</span><span class="mi">1656</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.15384615384615388
</pre></div>
</div>
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 14;
                var nbb_unformatted_code = "hazard = pmf_bulblife / at_risk\nhazard[1656]";
                var nbb_formatted_code = "hazard = pmf_bulblife / at_risk\nhazard[1656]";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>Of all bulbs that survived up to hour 1656, about 15% expired during hour 1656.</p>
<p>Instead of computing the hazard function ourselves, we can use <code class="docutils literal notranslate"><span class="pre">empiricaldist</span></code>, which provides a <code class="docutils literal notranslate"><span class="pre">Hazard</span></code> object that represents a hazard function, and a <code class="docutils literal notranslate"><span class="pre">make_hazard</span></code> method that computes it.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hazard_bulblife</span> <span class="o">=</span> <span class="n">surv_bulblife</span><span class="o">.</span><span class="n">make_hazard</span><span class="p">()</span>
<span class="n">hazard_bulblife</span><span class="p">[</span><span class="mi">1656</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.15384615384615397
</pre></div>
</div>
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 15;
                var nbb_unformatted_code = "hazard_bulblife = surv_bulblife.make_hazard()\nhazard_bulblife[1656]";
                var nbb_formatted_code = "hazard_bulblife = surv_bulblife.make_hazard()\nhazard_bulblife[1656]";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>Here’s what the hazard function looks like for the light bulbs.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hazard_bulblife</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">decorate</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;Light bulb duration (hours)&quot;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;Hazard&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/3dbd3641244c09056ebf25f5476594ceee5e4bbf4db8d78632e4586b9c1ad4f8.png" src="_images/3dbd3641244c09056ebf25f5476594ceee5e4bbf4db8d78632e4586b9c1ad4f8.png" />
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 16;
                var nbb_unformatted_code = "hazard_bulblife.plot()\ndecorate(xlabel=\"Light bulb duration (hours)\", ylabel=\"Hazard\")";
                var nbb_formatted_code = "hazard_bulblife.plot()\ndecorate(xlabel=\"Light bulb duration (hours)\", ylabel=\"Hazard\")";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>We can see that the hazard is higher in some places than others, but this way of visualizing the hazard function can be misleading, especially in parts of the range where we don’t have much data.
A better alternative is to plot the cumulative hazard function, which is the cumulative sum of the hazards.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cumulative_hazard</span> <span class="o">=</span> <span class="n">hazard_bulblife</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
<span class="n">cumulative_hazard</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>

<span class="n">decorate</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;Light bulb duration (hours)&quot;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;Cumulative hazard&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/6d8de174631bb840e5953e6eab185fdf8baf16e5246f141ca6a5872d39a6f753.png" src="_images/6d8de174631bb840e5953e6eab185fdf8baf16e5246f141ca6a5872d39a6f753.png" />
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 17;
                var nbb_unformatted_code = "cumulative_hazard = hazard_bulblife.cumsum()\ncumulative_hazard.plot()\n\ndecorate(xlabel=\"Light bulb duration (hours)\", ylabel=\"Cumulative hazard\")";
                var nbb_formatted_code = "cumulative_hazard = hazard_bulblife.cumsum()\ncumulative_hazard.plot()\n\ndecorate(xlabel=\"Light bulb duration (hours)\", ylabel=\"Cumulative hazard\")";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>Where the probability of expiring is high, the cumulative hazard function is steep.
Where the probability of expiring is low, the cumulative hazard function is flat.
In this example, we can see that the interval with the highest hazards is between 1500 an 2000 hours.
After that, the hazards are actually a little lower – although this outcome is based on just one unusually long-lived battery, so it might look different in another dataset.</p>
<p>Now that we have the general idea of survival and hazard functions, let’s apply them to a more substantial dataset.</p>
</section>
<section id="marriage-data">
<h2><span class="section-number">13.3. </span>Marriage Data<a class="headerlink" href="#marriage-data" title="Link to this heading">#</a></h2>
<p>In many other countries, people are getting married later than they used to, and more people stay unmarried.
To explore these trends in the United States, we’ll use the tools of survival analysis and data from the National Survey of Family Growth (NSFG).</p>
<p>The NSFG dataset we used in previous chapters is the pregnancy file, which contains one row for each pregnancy reported by the survey respondents.
In this chapter, we’ll work with the respondent file, which contains information about the respondents themselves.</p>
<p>I have compiled responses from nine iterations of the survey, conducted between 1982 and 2019, and selected data related to marriage.
Instructions for downloading this excerpt are in the notebook for this chapter.</p>
<p>The following cell downloads the data, which is a CSV file I created that combines data from several iterations of the NSFG survey, from 1982 to 2019.</p>
<p>Details of the data preparation are in <a class="reference external" href="https://github.com/AllenDowney/MarriageNSFG/blob/master/clean_nsfg.ipynb">this notebook</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;marriage_nsfg_female.csv.gz&quot;</span>
<span class="n">download</span><span class="p">(</span><span class="s2">&quot;https://github.com/AllenDowney/ThinkStats/raw/v3/data/&quot;</span> <span class="o">+</span> <span class="n">filename</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 18;
                var nbb_unformatted_code = "filename = \"marriage_nsfg_female.csv.gz\"\ndownload(\"https://github.com/AllenDowney/ThinkStats/raw/v3/data/\" + filename)";
                var nbb_formatted_code = "filename = \"marriage_nsfg_female.csv.gz\"\ndownload(\"https://github.com/AllenDowney/ThinkStats/raw/v3/data/\" + filename)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>We can read the data like this.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">resp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;marriage_nsfg_female.csv.gz&quot;</span><span class="p">)</span>
<span class="n">resp</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(70183, 34)
</pre></div>
</div>
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 19;
                var nbb_unformatted_code = "resp = pd.read_csv(\"marriage_nsfg_female.csv.gz\")\nresp.shape";
                var nbb_formatted_code = "resp = pd.read_csv(\"marriage_nsfg_female.csv.gz\")\nresp.shape";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>The excerpt includes one row for each of more than 70,000 respondents, and includes the following variables related to age and marriage.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">cmbirth</span></code>: The respondent’s date of birth, known for all respondents.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">cmintvw</span></code>: The date the respondent was interviewed, known for all respondents.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">cmmarrhx</span></code>: The date the respondent was first married, if applicable and known.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">evrmarry</span></code>: 1 if the respondent had been married prior to the date of interview, 0 otherwise.</p></li>
</ul>
<p>The first three variables are encoded in “century-months” – that is, the integer number of months since December 1899.
So century-month 1 is January 1900.</p>
<p>To explore generational changes, we will group respondents by their decade of birth.
We’ll use the following function, which takes a value of <code class="docutils literal notranslate"><span class="pre">cmbirth</span></code> and computes the corresponding decade of birth.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">month0</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="s2">&quot;1899-12-31&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">decade_of_birth</span><span class="p">(</span><span class="n">cmbirth</span><span class="p">):</span>
    <span class="n">date</span> <span class="o">=</span> <span class="n">month0</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="n">cmbirth</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">date</span><span class="o">.</span><span class="n">year</span> <span class="o">//</span> <span class="mi">10</span> <span class="o">*</span> <span class="mi">10</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 20;
                var nbb_unformatted_code = "month0 = pd.to_datetime(\"1899-12-31\")\n\n\ndef decade_of_birth(cmbirth):\n    date = month0 + pd.DateOffset(months=cmbirth)\n    return date.year // 10 * 10";
                var nbb_formatted_code = "month0 = pd.to_datetime(\"1899-12-31\")\n\n\ndef decade_of_birth(cmbirth):\n    date = month0 + pd.DateOffset(months=cmbirth)\n    return date.year // 10 * 10";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>We can use this function and the <code class="docutils literal notranslate"><span class="pre">apply</span></code> method to compute each respondent’s decade of birth and assign it to a new column called <code class="docutils literal notranslate"><span class="pre">cohort</span></code>.
In this context, a <strong>cohort</strong> is a group of people with something in common – like they decade they were born – who are treated as a group for purposes of analysis.</p>
<p>The result from <code class="docutils literal notranslate"><span class="pre">value_counts</span></code> shows the number of people in each cohort.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">thinkstats</span> <span class="kn">import</span> <span class="n">value_counts</span>

<span class="n">resp</span><span class="p">[</span><span class="s2">&quot;cohort&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">resp</span><span class="p">[</span><span class="s2">&quot;cmbirth&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">decade_of_birth</span><span class="p">)</span>
<span class="n">value_counts</span><span class="p">(</span><span class="n">resp</span><span class="p">[</span><span class="s2">&quot;cohort&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>cohort
1930      325
1940     3608
1950    10631
1960    14953
1970    16438
1980    14271
1990     8552
2000     1405
Name: count, dtype: int64
</pre></div>
</div>
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 21;
                var nbb_unformatted_code = "from thinkstats import value_counts\n\nresp[\"cohort\"] = resp[\"cmbirth\"].apply(decade_of_birth)\nvalue_counts(resp[\"cohort\"])";
                var nbb_formatted_code = "from thinkstats import value_counts\n\nresp[\"cohort\"] = resp[\"cmbirth\"].apply(decade_of_birth)\nvalue_counts(resp[\"cohort\"])";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>We have more than 10,000 respondents born in each decade from the 1950s to the 1980s, and fewer respondents in the earlier and later decades.</p>
<p>Next we’ll compute each respondent’s age when married (if applicable) and their age when interviewed.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">resp</span><span class="p">[</span><span class="s2">&quot;agemarr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">resp</span><span class="p">[</span><span class="s2">&quot;cmmarrhx&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">resp</span><span class="p">[</span><span class="s2">&quot;cmbirth&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="mi">12</span>
<span class="n">resp</span><span class="p">[</span><span class="s2">&quot;age&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">resp</span><span class="p">[</span><span class="s2">&quot;cmintvw&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">resp</span><span class="p">[</span><span class="s2">&quot;cmbirth&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="mi">12</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 22;
                var nbb_unformatted_code = "resp[\"agemarr\"] = (resp[\"cmmarrhx\"] - resp[\"cmbirth\"]) / 12\nresp[\"age\"] = (resp[\"cmintvw\"] - resp[\"cmbirth\"]) / 12";
                var nbb_formatted_code = "resp[\"agemarr\"] = (resp[\"cmmarrhx\"] - resp[\"cmbirth\"]) / 12\nresp[\"age\"] = (resp[\"cmintvw\"] - resp[\"cmbirth\"]) / 12";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>To get started with this data, we’ll use the following function, which takes as parameters the dataset and a list of cohorts.
For each cohort, it selects their ages at first marriage and uses to compute a survival function.
The <code class="docutils literal notranslate"><span class="pre">dropna=False</span></code> argument tells <code class="docutils literal notranslate"><span class="pre">Surv.from_seq</span></code> to include <code class="docutils literal notranslate"><span class="pre">NaN</span></code> values in the survival function, so the result includes people who have not married.</p>
<p>The function returns a dictionary that maps from each integer cohort to a <code class="docutils literal notranslate"><span class="pre">Surv</span></code> object.
Note: This function is not correct – in later sections we’ll see what the problem is and fix it.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">empiricaldist</span> <span class="kn">import</span> <span class="n">Surv</span>


<span class="k">def</span> <span class="nf">make_survival_map</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="n">cohorts</span><span class="p">):</span>
    <span class="n">surv_map</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">grouped</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;cohort&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">cohort</span> <span class="ow">in</span> <span class="n">cohorts</span><span class="p">:</span>
        <span class="n">group</span> <span class="o">=</span> <span class="n">grouped</span><span class="o">.</span><span class="n">get_group</span><span class="p">(</span><span class="n">cohort</span><span class="p">)</span>
        <span class="n">surv_map</span><span class="p">[</span><span class="n">cohort</span><span class="p">]</span> <span class="o">=</span> <span class="n">Surv</span><span class="o">.</span><span class="n">from_seq</span><span class="p">(</span><span class="n">group</span><span class="p">[</span><span class="s2">&quot;agemarr&quot;</span><span class="p">],</span> <span class="n">dropna</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">surv_map</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 23;
                var nbb_unformatted_code = "from empiricaldist import Surv\n\n\ndef make_survival_map(resp, cohorts):\n    surv_map = {}\n\n    grouped = resp.groupby(\"cohort\")\n    for cohort in cohorts:\n        group = grouped.get_group(cohort)\n        surv_map[cohort] = Surv.from_seq(group[\"agemarr\"], dropna=False)\n\n    return surv_map";
                var nbb_formatted_code = "from empiricaldist import Surv\n\n\ndef make_survival_map(resp, cohorts):\n    surv_map = {}\n\n    grouped = resp.groupby(\"cohort\")\n    for cohort in cohorts:\n        group = grouped.get_group(cohort)\n        surv_map[cohort] = Surv.from_seq(group[\"agemarr\"], dropna=False)\n\n    return surv_map";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>Here’s how we use this function.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cohorts</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1980</span><span class="p">,</span> <span class="mi">1960</span><span class="p">,</span> <span class="mi">1940</span><span class="p">]</span>
<span class="n">surv_map</span> <span class="o">=</span> <span class="n">make_survival_map</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="n">cohorts</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 24;
                var nbb_unformatted_code = "cohorts = [1980, 1960, 1940]\nsurv_map = make_survival_map(resp, cohorts)";
                var nbb_formatted_code = "cohorts = [1980, 1960, 1940]\nsurv_map = make_survival_map(resp, cohorts)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>And here are the results for people born in the 1940s, 1960s, and 1980s.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">cohort</span><span class="p">,</span> <span class="n">surv</span> <span class="ow">in</span> <span class="n">surv_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">surv</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cohort</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>

<span class="n">decorate</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;Age&quot;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;Prob never married&quot;</span><span class="p">,</span> <span class="n">ylim</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">1.05</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/4fbad48b04c4b6e5439e5859adef6c6595fbedda47fd68f9609e170d74f15019.png" src="_images/4fbad48b04c4b6e5439e5859adef6c6595fbedda47fd68f9609e170d74f15019.png" />
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 25;
                var nbb_unformatted_code = "for cohort, surv in surv_map.items():\n    surv.plot(label=f\"{cohort}s\")\n\ndecorate(xlabel=\"Age\", ylabel=\"Prob never married\", ylim=[-0.05, 1.05])";
                var nbb_formatted_code = "for cohort, surv in surv_map.items():\n    surv.plot(label=f\"{cohort}s\")\n\ndecorate(xlabel=\"Age\", ylabel=\"Prob never married\", ylim=[-0.05, 1.05])";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>If we take these results at face value, they show that people in earlier generations got married younger, and more of them got married.
However, we should not interpret these results yet, because they are not correct.
There are two problems we have to address:</p>
<ul class="simple">
<li><p>As discussed in Section XXX, the NSFG uses stratified sampling, which means that it deliberated oversamples some groups.</p></li>
<li><p>This way of computing the survival function does not properly take into account people who are not married yet.</p></li>
</ul>
<p>For the first problem, we have already seen a solution, weighted resampling.
For the second problem, we will need a new method, Kaplan-Meier estimation.
We’ll start with resampling.</p>
</section>
<section id="weighted-resampling">
<h2><span class="section-number">13.4. </span>Weighted Resampling<a class="headerlink" href="#weighted-resampling" title="Link to this heading">#</a></h2>
<p>The NSFG dataset includes a column called <code class="docutils literal notranslate"><span class="pre">finalwgt</span></code> that contains each respondent’s sampling weight, which is the number of people in the population they represent.
We can use these weights during the resampling process to correct for stratified sampling.
Here’s the function from Section XXX that does it.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">resample_rows_weighted</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="s2">&quot;finalwgt&quot;</span><span class="p">):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">column</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 26;
                var nbb_unformatted_code = "def resample_rows_weighted(df, column=\"finalwgt\"):\n    n = len(df)\n    weights = df[column]\n    return df.sample(n, weights=weights, replace=True)";
                var nbb_formatted_code = "def resample_rows_weighted(df, column=\"finalwgt\"):\n    n = len(df)\n    weights = df[column]\n    return df.sample(n, weights=weights, replace=True)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>The current dataset includes respondents from several iterations of the survey, called cycles, so in order to resample, we have to group the respondents by cycle, resample each group, and then put the groups back together.
That’s what the following function does.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">resample_cycles</span><span class="p">(</span><span class="n">resp</span><span class="p">):</span>
    <span class="n">grouped</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;cycle&quot;</span><span class="p">)</span>
    <span class="n">samples</span> <span class="o">=</span> <span class="p">[</span><span class="n">resample_rows_weighted</span><span class="p">(</span><span class="n">group</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">grouped</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 27;
                var nbb_unformatted_code = "def resample_cycles(resp):\n    grouped = resp.groupby(\"cycle\")\n    samples = [resample_rows_weighted(group) for _, group in grouped]\n    return pd.concat(samples)";
                var nbb_formatted_code = "def resample_cycles(resp):\n    grouped = resp.groupby(\"cycle\")\n    samples = [resample_rows_weighted(group) for _, group in grouped]\n    return pd.concat(samples)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>To get started, we’ll resample the data once.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sample</span> <span class="o">=</span> <span class="n">resample_cycles</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 28;
                var nbb_unformatted_code = "sample = resample_cycles(resp)";
                var nbb_formatted_code = "sample = resample_cycles(resp)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>Later we’ll resample the data several times, so we can see how much variation there is due to random sample.</p>
<p>The following figure shows the results with resampling, compared to the results from the previous section without resampling, shown as dotted lines.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">surv</span> <span class="ow">in</span> <span class="n">surv_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">surv</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ls</span><span class="o">=</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>

<span class="n">survs_resampled</span> <span class="o">=</span> <span class="n">make_survival_map</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span> <span class="n">cohorts</span><span class="p">)</span>

<span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">surv</span> <span class="ow">in</span> <span class="n">survs_resampled</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">surv</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>

<span class="n">decorate</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;Age&quot;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;Prob never married&quot;</span><span class="p">,</span> <span class="n">ylim</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">1.05</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/ec85348cd6df6b7edcfc11f64c062037ee167f92bb1bcca2b50074613c00a8e2.png" src="_images/ec85348cd6df6b7edcfc11f64c062037ee167f92bb1bcca2b50074613c00a8e2.png" />
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 29;
                var nbb_unformatted_code = "for label, surv in surv_map.items():\n    surv.plot(ls=\":\", color=\"gray\", alpha=0.8)\n\nsurvs_resampled = make_survival_map(sample, cohorts)\n\nfor label, surv in survs_resampled.items():\n    surv.plot(label=label)\n\ndecorate(xlabel=\"Age\", ylabel=\"Prob never married\", ylim=[-0.05, 1.05])";
                var nbb_formatted_code = "for label, surv in surv_map.items():\n    surv.plot(ls=\":\", color=\"gray\", alpha=0.8)\n\nsurvs_resampled = make_survival_map(sample, cohorts)\n\nfor label, surv in survs_resampled.items():\n    surv.plot(label=label)\n\ndecorate(xlabel=\"Age\", ylabel=\"Prob never married\", ylim=[-0.05, 1.05])";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>The difference, with and without resampling, is substantial, which shows that we need to correct for stratified sampling to get accurate results.</p>
<p>Now let’s get to the second problem, dealing with incomplete data.</p>
</section>
<section id="estimating-survival-functions">
<h2><span class="section-number">13.5. </span>Estimating Survival Functions<a class="headerlink" href="#estimating-survival-functions" title="Link to this heading">#</a></h2>
<p>In the light bulb example, we know the life spans for all 50 bulbs, so we can compute the survival function directly – and we can use the survival function to compute the hazard function.</p>
<p>In the marriage example, we know the age at first marriage for some respondents, the ones who had been married before they were interviewed.
But for respondents who had had never married before they were interviewed, we don’t know at what age they will marry in the future – or if they will.</p>
<p>This kind of missing data is said to be <strong>censored</strong>.
That term might seem odd, because censored information is usually hidden deliberately, but in this case it is hidden just because we don’t know the future.</p>
<p>However, in this case we have partial information we can work with: if someone is unmarried when they are surveyed, we know that the age when they get married (if they do) must be greater than their current age.</p>
<p>We can use this partial information to estimate the hazard function; then we can use the hazard function to compute the survival function.
This process is called <strong>Kaplan-Meier estimation</strong>.</p>
<p>To demonstrate, I’ll select just one cohort from the resampled data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">resp60</span> <span class="o">=</span> <span class="n">sample</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;cohort == 1960&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 30;
                var nbb_unformatted_code = "resp60 = sample.query(\"cohort == 1960\")";
                var nbb_formatted_code = "resp60 = sample.query(\"cohort == 1960\")";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>For respondents who were married when they were surveyed, we’ll select their age at first marriage.
There are 10,222 of them, which we’ll call “completed” cases.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">complete</span> <span class="o">=</span> <span class="n">resp60</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;evrmarry == 1&quot;</span><span class="p">)[</span><span class="s2">&quot;agemarr&quot;</span><span class="p">]</span>
<span class="n">complete</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>10111
</pre></div>
</div>
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 31;
                var nbb_unformatted_code = "complete = resp60.query(\"evrmarry == 1\")[\"agemarr\"]\ncomplete.count()";
                var nbb_formatted_code = "complete = resp60.query(\"evrmarry == 1\")[\"agemarr\"]\ncomplete.count()";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>For respondents who had not married, we’ll select their age when they were surveyed.
There are 5,501 of them, which we’ll call the “ongoing” cases.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ongoing</span> <span class="o">=</span> <span class="n">resp60</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;evrmarry == 0&quot;</span><span class="p">)[</span><span class="s2">&quot;age&quot;</span><span class="p">]</span>
<span class="n">ongoing</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>5391
</pre></div>
</div>
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 32;
                var nbb_unformatted_code = "ongoing = resp60.query(\"evrmarry == 0\")[\"age\"]\nongoing.count()";
                var nbb_formatted_code = "ongoing = resp60.query(\"evrmarry == 0\")[\"age\"]\nongoing.count()";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>Now, to estimate the hazard function, we’ll compute the total number of cases that were “at risk” at each age, including everyone who was unmarried up to that age.
It will be convenient to make a <code class="docutils literal notranslate"><span class="pre">Hist</span></code> object that counts the number of complete and ongoing cases at each age.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">empiricaldist</span> <span class="kn">import</span> <span class="n">Hist</span>

<span class="n">hist_complete</span> <span class="o">=</span> <span class="n">Hist</span><span class="o">.</span><span class="n">from_seq</span><span class="p">(</span><span class="n">complete</span><span class="p">)</span>
<span class="n">hist_ongoing</span> <span class="o">=</span> <span class="n">Hist</span><span class="o">.</span><span class="n">from_seq</span><span class="p">(</span><span class="n">ongoing</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 33;
                var nbb_unformatted_code = "from empiricaldist import Hist\n\nhist_complete = Hist.from_seq(complete)\nhist_ongoing = Hist.from_seq(ongoing)";
                var nbb_formatted_code = "from empiricaldist import Hist\n\nhist_complete = Hist.from_seq(complete)\nhist_ongoing = Hist.from_seq(ongoing)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>As an example, there are 87 respondents who reported that they were married for the first time at age 25.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hist_complete</span><span class="p">[</span><span class="mi">25</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>62
</pre></div>
</div>
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 34;
                var nbb_unformatted_code = "hist_complete[25]";
                var nbb_formatted_code = "hist_complete[25]";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>And another 13 respondents who were surveyed at age 25 and reported that they had never married.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hist_ongoing</span><span class="p">[</span><span class="mi">25</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>6
</pre></div>
</div>
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 35;
                var nbb_unformatted_code = "hist_ongoing[25]";
                var nbb_formatted_code = "hist_ongoing[25]";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>From these <code class="docutils literal notranslate"><span class="pre">Hist</span></code> objects, we can compute unnormalized <code class="docutils literal notranslate"><span class="pre">Surv</span></code> objects that contain the number of complete and ongoing cases that exceed each age.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">surv_complete</span> <span class="o">=</span> <span class="n">hist_complete</span><span class="o">.</span><span class="n">make_surv</span><span class="p">()</span>
<span class="n">surv_ongoing</span> <span class="o">=</span> <span class="n">hist_ongoing</span><span class="o">.</span><span class="n">make_surv</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 36;
                var nbb_unformatted_code = "surv_complete = hist_complete.make_surv()\nsurv_ongoing = hist_ongoing.make_surv()";
                var nbb_formatted_code = "surv_complete = hist_complete.make_surv()\nsurv_ongoing = hist_ongoing.make_surv()";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>For example, there are 2937 people who reported getting married after age 25.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">surv_complete</span><span class="p">[</span><span class="mi">25</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2878
</pre></div>
</div>
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 37;
                var nbb_unformatted_code = "surv_complete[25]";
                var nbb_formatted_code = "surv_complete[25]";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>And 2306 people surveyed after age 25 who had never married.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">surv_ongoing</span><span class="p">[</span><span class="mi">25</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2161
</pre></div>
</div>
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 38;
                var nbb_unformatted_code = "surv_ongoing[25]";
                var nbb_formatted_code = "surv_ongoing[25]";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>The sum of the four numbers we just computed is the number of respondents who were “at risk” – that is, people who could have married at age 25.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">at_risk</span> <span class="o">=</span> <span class="n">hist_complete</span><span class="p">[</span><span class="mi">25</span><span class="p">]</span> <span class="o">+</span> <span class="n">hist_ongoing</span><span class="p">[</span><span class="mi">25</span><span class="p">]</span> <span class="o">+</span> <span class="n">surv_complete</span><span class="p">[</span><span class="mi">25</span><span class="p">]</span> <span class="o">+</span> <span class="n">surv_ongoing</span><span class="p">[</span><span class="mi">25</span><span class="p">]</span>
<span class="n">at_risk</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>5107
</pre></div>
</div>
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 39;
                var nbb_unformatted_code = "at_risk = hist_complete[25] + hist_ongoing[25] + surv_complete[25] + surv_ongoing[25]\nat_risk";
                var nbb_formatted_code = "at_risk = hist_complete[25] + hist_ongoing[25] + surv_complete[25] + surv_ongoing[25]\nat_risk";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>Of those, the number who actually married at age 25 is <code class="docutils literal notranslate"><span class="pre">hist_complete[25]</span></code>.
So we can compute the hazard function at age 25 like this.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hazard</span> <span class="o">=</span> <span class="n">hist_complete</span><span class="p">[</span><span class="mi">25</span><span class="p">]</span> <span class="o">/</span> <span class="n">at_risk</span>
<span class="n">hazard</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.012140199725866458
</pre></div>
</div>
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 40;
                var nbb_unformatted_code = "hazard = hist_complete[25] / at_risk\nhazard";
                var nbb_formatted_code = "hazard = hist_complete[25] / at_risk\nhazard";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>That’s how we can compute the hazard function at a single age.
Now let’s compute the whole function, for all ages.
We’ll use the <code class="docutils literal notranslate"><span class="pre">union</span></code> method of the <code class="docutils literal notranslate"><span class="pre">Index</span></code> class to compute a Pandas <code class="docutils literal notranslate"><span class="pre">Index</span></code> that contains all of the ages from <code class="docutils literal notranslate"><span class="pre">hist_complete</span></code> and <code class="docutils literal notranslate"><span class="pre">hist_ongoing</span></code>, in order.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ts</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Index</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">hist_complete</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">hist_ongoing</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 41;
                var nbb_unformatted_code = "ts = pd.Index.union(hist_complete.index, hist_ongoing.index)";
                var nbb_formatted_code = "ts = pd.Index.union(hist_complete.index, hist_ongoing.index)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>Now we can compute the number of people at risk at every age, by looking up the ages in <code class="docutils literal notranslate"><span class="pre">ts</span></code> in each of the  <code class="docutils literal notranslate"><span class="pre">Hist</span></code> and <code class="docutils literal notranslate"><span class="pre">Surv</span></code> objects.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">at_risk</span> <span class="o">=</span> <span class="n">hist_complete</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span> <span class="o">+</span> <span class="n">hist_ongoing</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span> <span class="o">+</span> <span class="n">surv_complete</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span> <span class="o">+</span> <span class="n">surv_ongoing</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 42;
                var nbb_unformatted_code = "at_risk = hist_complete(ts) + hist_ongoing(ts) + surv_complete(ts) + surv_ongoing(ts)";
                var nbb_formatted_code = "at_risk = hist_complete(ts) + hist_ongoing(ts) + surv_complete(ts) + surv_ongoing(ts)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>Finally, we can compute the hazard function at each age, and put the results into a <code class="docutils literal notranslate"><span class="pre">Hazard</span></code> object.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">empiricaldist</span> <span class="kn">import</span> <span class="n">Hazard</span>

<span class="n">hs</span> <span class="o">=</span> <span class="n">hist_complete</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span> <span class="o">/</span> <span class="n">at_risk</span>
<span class="n">hazard</span> <span class="o">=</span> <span class="n">Hazard</span><span class="p">(</span><span class="n">hs</span><span class="p">,</span> <span class="n">ts</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 43;
                var nbb_unformatted_code = "from empiricaldist import Hazard\n\nhs = hist_complete(ts) / at_risk\nhazard = Hazard(hs, ts)";
                var nbb_formatted_code = "from empiricaldist import Hazard\n\nhs = hist_complete(ts) / at_risk\nhazard = Hazard(hs, ts)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>Here’s what the cumulative hazard function looks like.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hazard</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>

<span class="n">decorate</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;Age&quot;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;Cumulative hazard&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/5efd99e78584812fd5d19b4537eadab4642ee8484d9a6b22946f82c3aa8febcc.png" src="_images/5efd99e78584812fd5d19b4537eadab4642ee8484d9a6b22946f82c3aa8febcc.png" />
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 44;
                var nbb_unformatted_code = "hazard.cumsum().plot()\n\ndecorate(xlabel=\"Age\", ylabel=\"Cumulative hazard\")";
                var nbb_formatted_code = "hazard.cumsum().plot()\n\ndecorate(xlabel=\"Age\", ylabel=\"Cumulative hazard\")";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>The cumulative hazard function is steepest between ages 20 and 30, which means that an unmarried person is in the greatest “danger” of getting married at these ages.
After that, the hazard gradually decreases.</p>
</section>
<section id="estimating-the-survival-function">
<h2><span class="section-number">13.6. </span>Estimating the Survival Function<a class="headerlink" href="#estimating-the-survival-function" title="Link to this heading">#</a></h2>
<p>If we are given a survival function, we know how to compute the hazard function.
Now let’s go in the other direction.</p>
<p>Here’s one way of thinking of it.
The hazard function indicates the probability of getting married at each age, if you have not already married.
So the complement of the hazard function if the probability of staying unmarried at each age.</p>
<p>In order to “survive” past a given age, <code class="docutils literal notranslate"><span class="pre">t</span></code>, you have at stay unmarried at every age up to and including <code class="docutils literal notranslate"><span class="pre">t</span></code>.
And the probability of doing that is the product of the complementary hazard function, which we can compute like this.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ps</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">hazard</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 45;
                var nbb_unformatted_code = "ps = (1 - hazard).cumprod()";
                var nbb_formatted_code = "ps = (1 - hazard).cumprod()";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">Hazard</span></code> object has a <code class="docutils literal notranslate"><span class="pre">make_surv</span></code> method that does this computation.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">surv</span> <span class="o">=</span> <span class="n">hazard</span><span class="o">.</span><span class="n">make_surv</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 46;
                var nbb_unformatted_code = "surv = hazard.make_surv()";
                var nbb_formatted_code = "surv = hazard.make_surv()";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>Here’s what the result looks like, compared to the previous result (dotted line), which corrected for stratified resampling, but did not handle censored data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">survs_resampled</span><span class="p">[</span><span class="mi">1960</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ls</span><span class="o">=</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;resampled&quot;</span><span class="p">)</span>
<span class="n">surv</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;Kaplan-Meier&quot;</span><span class="p">)</span>

<span class="n">decorate</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;Age&quot;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;Prob never married&quot;</span><span class="p">,</span> <span class="n">ylim</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">1.05</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/5903afa33e8e79645a533c45db08f7c7e19e95f7ed69b1e99257da9747d386ed.png" src="_images/5903afa33e8e79645a533c45db08f7c7e19e95f7ed69b1e99257da9747d386ed.png" />
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 47;
                var nbb_unformatted_code = "survs_resampled[1960].plot(ls=\":\", color=\"gray\", label=\"resampled\")\nsurv.plot(label=\"Kaplan-Meier\")\n\ndecorate(xlabel=\"Age\", ylabel=\"Prob never married\", ylim=[-0.05, 1.05])";
                var nbb_formatted_code = "survs_resampled[1960].plot(ls=\":\", color=\"gray\", label=\"resampled\")\nsurv.plot(label=\"Kaplan-Meier\")\n\ndecorate(xlabel=\"Age\", ylabel=\"Prob never married\", ylim=[-0.05, 1.05])";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>We can see how important it is to handle censored data correctly.</p>
<p>The following function encapsulates the steps of Kaplan-Meier estimation.
It takes as arguments sequences of survival times for complete and ongoing cases, and returns a <code class="docutils literal notranslate"><span class="pre">Hazard</span></code> object.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">estimate_hazard</span><span class="p">(</span><span class="n">complete</span><span class="p">,</span> <span class="n">ongoing</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Kaplan-Meier estimation.&quot;&quot;&quot;</span>
    <span class="n">hist_complete</span> <span class="o">=</span> <span class="n">Hist</span><span class="o">.</span><span class="n">from_seq</span><span class="p">(</span><span class="n">complete</span><span class="p">)</span>
    <span class="n">hist_ongoing</span> <span class="o">=</span> <span class="n">Hist</span><span class="o">.</span><span class="n">from_seq</span><span class="p">(</span><span class="n">ongoing</span><span class="p">)</span>

    <span class="n">surv_complete</span> <span class="o">=</span> <span class="n">hist_complete</span><span class="o">.</span><span class="n">make_surv</span><span class="p">()</span>
    <span class="n">surv_ongoing</span> <span class="o">=</span> <span class="n">hist_ongoing</span><span class="o">.</span><span class="n">make_surv</span><span class="p">()</span>

    <span class="n">ts</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Index</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">hist_complete</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">hist_ongoing</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
    <span class="n">at_risk</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">hist_complete</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span> <span class="o">+</span> <span class="n">hist_ongoing</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span> <span class="o">+</span> <span class="n">surv_complete</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span> <span class="o">+</span> <span class="n">surv_ongoing</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="n">hs</span> <span class="o">=</span> <span class="n">hist_complete</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span> <span class="o">/</span> <span class="n">at_risk</span>
    <span class="k">return</span> <span class="n">Hazard</span><span class="p">(</span><span class="n">hs</span><span class="p">,</span> <span class="n">ts</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 48;
                var nbb_unformatted_code = "def estimate_hazard(complete, ongoing):\n    \"\"\"Kaplan-Meier estimation.\"\"\"\n    hist_complete = Hist.from_seq(complete)\n    hist_ongoing = Hist.from_seq(ongoing)\n\n    surv_complete = hist_complete.make_surv()\n    surv_ongoing = hist_ongoing.make_surv()\n\n    ts = pd.Index.union(hist_complete.index, hist_ongoing.index)\n    at_risk = (\n        hist_complete(ts) + hist_ongoing(ts) + surv_complete(ts) + surv_ongoing(ts)\n    )\n\n    hs = hist_complete(ts) / at_risk\n    return Hazard(hs, ts)";
                var nbb_formatted_code = "def estimate_hazard(complete, ongoing):\n    \"\"\"Kaplan-Meier estimation.\"\"\"\n    hist_complete = Hist.from_seq(complete)\n    hist_ongoing = Hist.from_seq(ongoing)\n\n    surv_complete = hist_complete.make_surv()\n    surv_ongoing = hist_ongoing.make_surv()\n\n    ts = pd.Index.union(hist_complete.index, hist_ongoing.index)\n    at_risk = (\n        hist_complete(ts) + hist_ongoing(ts) + surv_complete(ts) + surv_ongoing(ts)\n    )\n\n    hs = hist_complete(ts) / at_risk\n    return Hazard(hs, ts)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>And here’s a function that takes a group of respondents, extracts survival times, calls <code class="docutils literal notranslate"><span class="pre">estimate_hazard</span></code> to get the hazard function, and then computes the corresponding survival function.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">estimate_survival</span><span class="p">(</span><span class="n">group</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Estimate the survival function.&quot;&quot;&quot;</span>
    <span class="n">complete</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;evrmarry == 1&quot;</span><span class="p">)[</span><span class="s2">&quot;agemarr&quot;</span><span class="p">]</span>
    <span class="n">ongoing</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;evrmarry == 0&quot;</span><span class="p">)[</span><span class="s2">&quot;age&quot;</span><span class="p">]</span>
    <span class="n">hf</span> <span class="o">=</span> <span class="n">estimate_hazard</span><span class="p">(</span><span class="n">complete</span><span class="p">,</span> <span class="n">ongoing</span><span class="p">)</span>
    <span class="n">sf</span> <span class="o">=</span> <span class="n">hf</span><span class="o">.</span><span class="n">make_surv</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">sf</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 49;
                var nbb_unformatted_code = "def estimate_survival(group):\n    \"\"\"Estimate the survival function.\"\"\"\n    complete = group.query(\"evrmarry == 1\")[\"agemarr\"]\n    ongoing = group.query(\"evrmarry == 0\")[\"age\"]\n    hf = estimate_hazard(complete, ongoing)\n    sf = hf.make_surv()\n    return sf";
                var nbb_formatted_code = "def estimate_survival(group):\n    \"\"\"Estimate the survival function.\"\"\"\n    complete = group.query(\"evrmarry == 1\")[\"agemarr\"]\n    ongoing = group.query(\"evrmarry == 0\")[\"age\"]\n    hf = estimate_hazard(complete, ongoing)\n    sf = hf.make_surv()\n    return sf";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>In the next section, we’ll use these functions to compute confidence intervals for survival functions.</p>
</section>
<section id="lifelines">
<h2><span class="section-number">13.7. </span>Lifelines<a class="headerlink" href="#lifelines" title="Link to this heading">#</a></h2>
<p>There is a Python package called <code class="docutils literal notranslate"><span class="pre">lifelines</span></code> that includes tools for survival analysis, including functions that compute Kaplan-Meier estimates.</p>
<p>The following cell installs <code class="docutils literal notranslate"><span class="pre">lifelines</span></code> if necessary.</p>
<div class="cell tag_remove-print docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">lifelines</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="o">!</span>pip<span class="w"> </span>install<span class="w"> </span>lifelines
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 50;
                var nbb_unformatted_code = "try:\n    import lifelines\nexcept ImportError:\n    !pip install lifelines";
                var nbb_formatted_code = "try:\n    import lifelines\nexcept ImportError:\n    !pip install lifelines";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>We can use it to confirm that the computation in the previous section is correct.
First we’ll compute the survival curve using <code class="docutils literal notranslate"><span class="pre">estimate_survival</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">surv</span> <span class="o">=</span> <span class="n">estimate_survival</span><span class="p">(</span><span class="n">resp60</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 51;
                var nbb_unformatted_code = "surv = estimate_survival(resp60)";
                var nbb_formatted_code = "surv = estimate_survival(resp60)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>Next we’ll compute it using <code class="docutils literal notranslate"><span class="pre">lifelines</span></code>.
We have to do a little work to get the data into the format <code class="docutils literal notranslate"><span class="pre">lifelines</span></code> requires.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">complete</span> <span class="o">=</span> <span class="n">complete</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
<span class="n">durations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">complete</span><span class="p">,</span> <span class="n">ongoing</span><span class="p">])</span>
<span class="n">event_observed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">complete</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ongoing</span><span class="p">))])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 52;
                var nbb_unformatted_code = "complete = complete.dropna()\ndurations = np.concatenate([complete, ongoing])\nevent_observed = np.concatenate([np.ones(len(complete)), np.zeros(len(ongoing))])";
                var nbb_formatted_code = "complete = complete.dropna()\ndurations = np.concatenate([complete, ongoing])\nevent_observed = np.concatenate([np.ones(len(complete)), np.zeros(len(ongoing))])";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>Now we can make a <code class="docutils literal notranslate"><span class="pre">KaplanMeierFitter</span></code> object and fit the data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">lifelines</span> <span class="kn">import</span> <span class="n">KaplanMeierFitter</span>

<span class="n">kmf</span> <span class="o">=</span> <span class="n">KaplanMeierFitter</span><span class="p">()</span>
<span class="n">kmf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">durations</span><span class="o">=</span><span class="n">durations</span><span class="p">,</span> <span class="n">event_observed</span><span class="o">=</span><span class="n">event_observed</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;lifelines.KaplanMeierFitter:&quot;KM_estimate&quot;, fitted with 15502 total observations, 5391 right-censored observations&gt;
</pre></div>
</div>
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 53;
                var nbb_unformatted_code = "from lifelines import KaplanMeierFitter\n\nkmf = KaplanMeierFitter()\nkmf.fit(durations=durations, event_observed=event_observed)";
                var nbb_formatted_code = "from lifelines import KaplanMeierFitter\n\nkmf = KaplanMeierFitter()\nkmf.fit(durations=durations, event_observed=event_observed)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>After fitting the data, we can call the <code class="docutils literal notranslate"><span class="pre">plot</span></code> function to display the results, which include the estimated survival function and a confidence interval – although the confidence interval is not correct in this case because it doesn’t correct for stratified sampling.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">kmf</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Axes: xlabel=&#39;timeline&#39;&gt;
</pre></div>
</div>
<img alt="_images/00d06ce2d2c99878d5705c433b016f434fd259fbf673ad49fe3d07b47846f2bb.png" src="_images/00d06ce2d2c99878d5705c433b016f434fd259fbf673ad49fe3d07b47846f2bb.png" />
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 54;
                var nbb_unformatted_code = "kmf.plot()";
                var nbb_formatted_code = "kmf.plot()";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>The results from lifelines are slightly different from the results we computed because they start from 0.
But all of the other values in the results are the same, within floating-point error.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ps</span> <span class="o">=</span> <span class="n">kmf</span><span class="o">.</span><span class="n">survival_function_</span><span class="p">[</span><span class="s2">&quot;KM_estimate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">ps</span><span class="p">,</span> <span class="n">surv</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 55;
                var nbb_unformatted_code = "ps = kmf.survival_function_[\"KM_estimate\"].drop(0)\nnp.allclose(ps, surv)";
                var nbb_formatted_code = "ps = kmf.survival_function_[\"KM_estimate\"].drop(0)\nnp.allclose(ps, surv)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>In the next section, we’ll use weighted resampling to compute confidence intervals.</p>
</section>
<section id="confidence-intervals">
<h2><span class="section-number">13.8. </span>Confidence Intervals<a class="headerlink" href="#confidence-intervals" title="Link to this heading">#</a></h2>
<p>The Kaplan-Meier estimate we computed is based on a single resampling of the dataset.
To get an idea of how much variation there is due to random sampling, we’ll run the analysis with several resamplings and plot the results.</p>
<p>We’ll use the following function, which takes a <code class="docutils literal notranslate"><span class="pre">DataFrame</span></code> and a list of cohorts, estimates the survival function for each cohort, and returns a dictionary that maps from each integer cohort to a <code class="docutils literal notranslate"><span class="pre">Surv</span></code> object.
This function is identical to <code class="docutils literal notranslate"><span class="pre">make_survival_map</span></code> in Section xxx, except that it calls <code class="docutils literal notranslate"><span class="pre">estimate_survival</span></code>, which uses Kaplan-Meier estimation, rather than <code class="docutils literal notranslate"><span class="pre">Surv.from_seq</span></code>, which only works if there is no censored data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">estimate_survival_map</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="n">cohorts</span><span class="p">):</span>
    <span class="n">surv_map</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">grouped</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;cohort&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">cohort</span> <span class="ow">in</span> <span class="n">cohorts</span><span class="p">:</span>
        <span class="n">group</span> <span class="o">=</span> <span class="n">grouped</span><span class="o">.</span><span class="n">get_group</span><span class="p">(</span><span class="n">cohort</span><span class="p">)</span>
        <span class="n">surv_map</span><span class="p">[</span><span class="n">cohort</span><span class="p">]</span> <span class="o">=</span> <span class="n">estimate_survival</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">surv_map</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 56;
                var nbb_unformatted_code = "def estimate_survival_map(resp, cohorts):\n    surv_map = {}\n\n    grouped = resp.groupby(\"cohort\")\n    for cohort in cohorts:\n        group = grouped.get_group(cohort)\n        surv_map[cohort] = estimate_survival(group)\n\n    return surv_map";
                var nbb_formatted_code = "def estimate_survival_map(resp, cohorts):\n    surv_map = {}\n\n    grouped = resp.groupby(\"cohort\")\n    for cohort in cohorts:\n        group = grouped.get_group(cohort)\n        surv_map[cohort] = estimate_survival(group)\n\n    return surv_map";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>The following loop generates 101 random resamplings of the dataset, weighted to correct for stratified sampling, and makes a list of 101 dictionaries containing the estimated survival curves.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cohorts</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1940</span><span class="p">,</span> <span class="mi">1950</span><span class="p">,</span> <span class="mi">1960</span><span class="p">,</span> <span class="mi">1970</span><span class="p">,</span> <span class="mi">1980</span><span class="p">,</span> <span class="mi">1990</span><span class="p">]</span>

<span class="n">surv_maps</span> <span class="o">=</span> <span class="p">[</span><span class="n">estimate_survival_map</span><span class="p">(</span><span class="n">resample_cycles</span><span class="p">(</span><span class="n">resp</span><span class="p">),</span> <span class="n">cohorts</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">101</span><span class="p">)]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 57;
                var nbb_unformatted_code = "cohorts = [1940, 1950, 1960, 1970, 1980, 1990]\n\nsurv_maps = [estimate_survival_map(resample_cycles(resp), cohorts) for i in range(101)]";
                var nbb_formatted_code = "cohorts = [1940, 1950, 1960, 1970, 1980, 1990]\n\nsurv_maps = [estimate_survival_map(resample_cycles(resp), cohorts) for i in range(101)]";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>To plot the results, we’ll use the following function, which takes that list of dictionaries, and integer cohort, and a color string.
It loops through the dictionaries, selects the survival function for the given cohort, and plots it with a nearly transparent line – which is one way to visualize the variability between resamplings.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot_cohort</span><span class="p">(</span><span class="n">surv_maps</span><span class="p">,</span> <span class="n">cohort</span><span class="p">,</span> <span class="n">color</span><span class="p">):</span>
    <span class="n">survs</span> <span class="o">=</span> <span class="p">[</span><span class="n">surv_map</span><span class="p">[</span><span class="n">cohort</span><span class="p">]</span> <span class="k">for</span> <span class="n">surv_map</span> <span class="ow">in</span> <span class="n">surv_maps</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">surv</span> <span class="ow">in</span> <span class="n">survs</span><span class="p">:</span>
        <span class="n">surv</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>

    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">surv</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">surv</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cohort</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 58;
                var nbb_unformatted_code = "def plot_cohort(surv_maps, cohort, color):\n    survs = [surv_map[cohort] for surv_map in surv_maps]\n    for surv in survs:\n        surv.plot(color=color, alpha=0.05)\n\n    x, y = surv.index[-1], surv.iloc[-1]\n    plt.text(x + 1, y, f\"{cohort}s\", ha=\"left\", va=\"center\")";
                var nbb_formatted_code = "def plot_cohort(surv_maps, cohort, color):\n    survs = [surv_map[cohort] for surv_map in surv_maps]\n    for surv in survs:\n        surv.plot(color=color, alpha=0.05)\n\n    x, y = surv.index[-1], surv.iloc[-1]\n    plt.text(x + 1, y, f\"{cohort}s\", ha=\"left\", va=\"center\")";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>Here are the results for which cohorts…</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">thinkstats</span> <span class="kn">import</span> <span class="n">remove_spines</span>

<span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;C</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cohorts</span><span class="p">))]</span>

<span class="k">for</span> <span class="n">cohort</span><span class="p">,</span> <span class="n">color</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">cohorts</span><span class="p">,</span> <span class="n">colors</span><span class="p">):</span>
    <span class="n">plot_cohort</span><span class="p">(</span><span class="n">surv_maps</span><span class="p">,</span> <span class="n">cohort</span><span class="p">,</span> <span class="n">color</span><span class="p">)</span>

<span class="n">remove_spines</span><span class="p">()</span>

<span class="n">decorate</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;Age&quot;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;Prob never married&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/e0d234689bd6b51edb1fe657bb3f4a0bff74847635a43cff2b54f92fcf48d114.png" src="_images/e0d234689bd6b51edb1fe657bb3f4a0bff74847635a43cff2b54f92fcf48d114.png" />
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 59;
                var nbb_unformatted_code = "from thinkstats import remove_spines\n\ncolors = [f\"C{i}\" for i in range(len(cohorts))]\n\nfor cohort, color in zip(cohorts, colors):\n    plot_cohort(surv_maps, cohort, color)\n\nremove_spines()\n\ndecorate(xlabel=\"Age\", ylabel=\"Prob never married\")";
                var nbb_formatted_code = "from thinkstats import remove_spines\n\ncolors = [f\"C{i}\" for i in range(len(cohorts))]\n\nfor cohort, color in zip(cohorts, colors):\n    plot_cohort(surv_maps, cohort, color)\n\nremove_spines()\n\ndecorate(xlabel=\"Age\", ylabel=\"Prob never married\")";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>Several patterns are visible:</p>
<ul class="simple">
<li><p>Women born in the 50s married earliest, with successive cohorts marrying later and later, at least until age 30 or so.</p></li>
<li><p>Women born in the 60s follow a surprising pattern.
Prior to age 25, they were marrying at slower rates than their predecessors.
After age 25, they were marrying faster.
By age 32 they had overtaken the 50s cohort, and at age 44 they are substantially more likely to have married.</p></li>
</ul>
<p>A surv like this was the basis of a famous magazine article in 1986; <em>Newsweek</em> reported that a 40-year old unmarried woman was “more likely to be killed by a terrorist” than get married.
These statistics were widely reported and became part of popular culture, but they were wrong then (because they were based on faulty analysis) and turned out to be even more wrong (because of cultural changes that were already in progress and continued).
In 2006, <em>Newsweek</em> ran an another article admitting that they were wrong.</p>
<p>I encourage you to read more about this article, the statistics it was based on, and the reaction.
It should remind you of the ethical obligation to perform statistical analysis with care, interpret the results with appropriate skepticism, and present them to the public accurately and honestly.</p>
<p>Women born in the 60s turned 25 between 1985 and 1995.
Remembering that the <em>Newsweek</em> article I mentioned was published in 1986, it is tempting to imagine that the article triggered a marriage boom.
That explanation would be too pat, but it is possible that the article and the reaction to it were indicative of a mood that affected the behavior of this cohort.</p>
<ul class="simple">
<li><p>The pattern of the 70s cohort is similar.
They are less likely than their predecessors to be married before age 25, but at age 35 they have caught up with both of the previous cohorts.</p></li>
<li><p>Women born in the 80s are even less likely to marry before age 25. What happens after that is not clear; for more data, we have to wait for the next cycle of the NSFG.</p></li>
</ul>
<p>In the meantime we can make some predictions.</p>
</section>
<section id="expected-remaining-lifetime">
<h2><span class="section-number">13.9. </span>Expected remaining lifetime<a class="headerlink" href="#expected-remaining-lifetime" title="Link to this heading">#</a></h2>
<p>Given a survival function, we can compute the expected remaining lifetime as a function of current age.
For example, given the survival function of pregnancy length, we can compute the expected time until delivery.</p>
<p>The first step is to extract the PMF of lifetimes.
<code class="docutils literal notranslate"><span class="pre">SurvivalFunction</span></code> provides a method that does that:</p>
<p>The following cells download the data files and install <code class="docutils literal notranslate"><span class="pre">statadict</span></code>, which we need to read the data.</p>
<div class="cell tag_remove-print docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">download</span><span class="p">(</span><span class="s2">&quot;https://github.com/AllenDowney/ThinkStats/raw/v3/nb/nsfg.py&quot;</span><span class="p">)</span>
<span class="n">download</span><span class="p">(</span><span class="s2">&quot;https://github.com/AllenDowney/ThinkStats/raw/v3/data/2002FemPreg.dct&quot;</span><span class="p">)</span>
<span class="n">download</span><span class="p">(</span><span class="s2">&quot;https://github.com/AllenDowney/ThinkStats/raw/v3/data/2002FemPreg.dat.gz&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 60;
                var nbb_unformatted_code = "download(\"https://github.com/AllenDowney/ThinkStats/raw/v3/nb/nsfg.py\")\ndownload(\"https://github.com/AllenDowney/ThinkStats/raw/v3/data/2002FemPreg.dct\")\ndownload(\"https://github.com/AllenDowney/ThinkStats/raw/v3/data/2002FemPreg.dat.gz\")";
                var nbb_formatted_code = "download(\"https://github.com/AllenDowney/ThinkStats/raw/v3/nb/nsfg.py\")\ndownload(\"https://github.com/AllenDowney/ThinkStats/raw/v3/data/2002FemPreg.dct\")\ndownload(\"https://github.com/AllenDowney/ThinkStats/raw/v3/data/2002FemPreg.dat.gz\")";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<div class="cell tag_remove-print docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">statadict</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="o">!</span>pip<span class="w"> </span>install<span class="w"> </span>statadict
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 61;
                var nbb_unformatted_code = "try:\n    import statadict\nexcept ImportError:\n    !pip install statadict";
                var nbb_formatted_code = "try:\n    import statadict\nexcept ImportError:\n    !pip install statadict";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">nsfg</span> <span class="kn">import</span> <span class="n">get_nsfg_groups</span>

<span class="n">live</span><span class="p">,</span> <span class="n">firsts</span><span class="p">,</span> <span class="n">others</span> <span class="o">=</span> <span class="n">get_nsfg_groups</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 62;
                var nbb_unformatted_code = "from nsfg import get_nsfg_groups\n\nlive, firsts, others = get_nsfg_groups()";
                var nbb_formatted_code = "from nsfg import get_nsfg_groups\n\nlive, firsts, others = get_nsfg_groups()";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sample</span> <span class="o">=</span> <span class="n">resample_rows_weighted</span><span class="p">(</span><span class="n">live</span><span class="p">,</span> <span class="s2">&quot;finalwgt&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 63;
                var nbb_unformatted_code = "sample = resample_rows_weighted(live, \"finalwgt\")";
                var nbb_formatted_code = "sample = resample_rows_weighted(live, \"finalwgt\")";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pmf_durations</span> <span class="o">=</span> <span class="n">Pmf</span><span class="o">.</span><span class="n">from_seq</span><span class="p">(</span><span class="n">sample</span><span class="p">[</span><span class="s2">&quot;prglngth&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 64;
                var nbb_unformatted_code = "pmf_durations = Pmf.from_seq(sample[\"prglngth\"])";
                var nbb_formatted_code = "pmf_durations = Pmf.from_seq(sample[\"prglngth\"])";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">t</span> <span class="o">=</span> <span class="mi">36</span>
<span class="n">is_remaining</span> <span class="o">=</span> <span class="n">pmf_durations</span><span class="o">.</span><span class="n">qs</span> <span class="o">&gt;=</span> <span class="n">t</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 65;
                var nbb_unformatted_code = "t = 36\nis_remaining = pmf_durations.qs >= t";
                var nbb_formatted_code = "t = 36\nis_remaining = pmf_durations.qs >= t";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ps</span> <span class="o">=</span> <span class="n">pmf_durations</span><span class="o">.</span><span class="n">ps</span><span class="p">[</span><span class="n">is_remaining</span><span class="p">]</span>
<span class="n">qs</span> <span class="o">=</span> <span class="n">pmf_durations</span><span class="o">.</span><span class="n">qs</span><span class="p">[</span><span class="n">is_remaining</span><span class="p">]</span> <span class="o">-</span> <span class="n">t</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 66;
                var nbb_unformatted_code = "ps = pmf_durations.ps[is_remaining]\nqs = pmf_durations.qs[is_remaining] - t";
                var nbb_formatted_code = "ps = pmf_durations.ps[is_remaining]\nqs = pmf_durations.qs[is_remaining] - t";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pmf_remaining</span> <span class="o">=</span> <span class="n">Pmf</span><span class="p">(</span><span class="n">ps</span><span class="p">,</span> <span class="n">qs</span><span class="p">)</span>
<span class="n">pmf_remaining</span><span class="o">.</span><span class="n">normalize</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.9121119370354174
</pre></div>
</div>
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 67;
                var nbb_unformatted_code = "pmf_remaining = Pmf(ps, qs)\npmf_remaining.normalize()";
                var nbb_formatted_code = "pmf_remaining = Pmf(ps, qs)\npmf_remaining.normalize()";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pmf_remaining</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;Week 36&quot;</span><span class="p">)</span>
<span class="n">decorate</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;Remaining duration (weeks)&quot;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;PMF&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/a64bdcba604c946c42bfbfe55d497ee5a5899c8ac97c94aa60e991694abc634c.png" src="_images/a64bdcba604c946c42bfbfe55d497ee5a5899c8ac97c94aa60e991694abc634c.png" />
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 68;
                var nbb_unformatted_code = "pmf_remaining.bar(label=\"Week 36\")\ndecorate(xlabel=\"Remaining duration (weeks)\", ylabel=\"PMF\")";
                var nbb_formatted_code = "pmf_remaining.bar(label=\"Week 36\")\ndecorate(xlabel=\"Remaining duration (weeks)\", ylabel=\"PMF\")";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pmf_remaining</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>3.2623441994247373
</pre></div>
</div>
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 69;
                var nbb_unformatted_code = "pmf_remaining.mean()";
                var nbb_formatted_code = "pmf_remaining.mean()";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">compute_pmf_remaining</span><span class="p">(</span><span class="n">pmf</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; &quot;&quot;&quot;</span>
    <span class="n">is_remaining</span> <span class="o">=</span> <span class="n">pmf</span><span class="o">.</span><span class="n">qs</span> <span class="o">&gt;=</span> <span class="n">t</span>
    <span class="n">ps</span> <span class="o">=</span> <span class="n">pmf</span><span class="o">.</span><span class="n">ps</span><span class="p">[</span><span class="n">is_remaining</span><span class="p">]</span>
    <span class="n">qs</span> <span class="o">=</span> <span class="n">pmf</span><span class="o">.</span><span class="n">qs</span><span class="p">[</span><span class="n">is_remaining</span><span class="p">]</span> <span class="o">-</span> <span class="n">t</span>
    <span class="n">pmf_remaining</span> <span class="o">=</span> <span class="n">Pmf</span><span class="p">(</span><span class="n">ps</span><span class="p">,</span> <span class="n">qs</span><span class="p">)</span>
    <span class="n">pmf_remaining</span><span class="o">.</span><span class="n">normalize</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">pmf_remaining</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 70;
                var nbb_unformatted_code = "def compute_pmf_remaining(pmf, t):\n    \"\"\"\n    \"\"\"\n    is_remaining = pmf.qs >= t\n    ps = pmf.ps[is_remaining]\n    qs = pmf.qs[is_remaining] - t\n    pmf_remaining = Pmf(ps, qs)\n    pmf_remaining.normalize()\n    return pmf_remaining";
                var nbb_formatted_code = "def compute_pmf_remaining(pmf, t):\n    \"\"\" \"\"\"\n    is_remaining = pmf.qs >= t\n    ps = pmf.ps[is_remaining]\n    qs = pmf.qs[is_remaining] - t\n    pmf_remaining = Pmf(ps, qs)\n    pmf_remaining.normalize()\n    return pmf_remaining";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">expected_remaining</span><span class="p">(</span><span class="n">pmf</span><span class="p">):</span>
    <span class="n">index</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">36</span><span class="p">,</span> <span class="mi">44</span><span class="p">)</span>
    <span class="n">expected</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">index</span><span class="p">:</span>
        <span class="n">pmf_remaining</span> <span class="o">=</span> <span class="n">compute_pmf_remaining</span><span class="p">(</span><span class="n">pmf</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
        <span class="n">expected</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">pmf_remaining</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">expected</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 71;
                var nbb_unformatted_code = "def expected_remaining(pmf):\n    index = range(36, 44)\n    expected = pd.Series(index=index)\n\n    for t in index:\n        pmf_remaining = compute_pmf_remaining(pmf, t)\n        expected[t] = pmf_remaining.mean()\n\n    return expected";
                var nbb_formatted_code = "def expected_remaining(pmf):\n    index = range(36, 44)\n    expected = pd.Series(index=index)\n\n    for t in index:\n        pmf_remaining = compute_pmf_remaining(pmf, t)\n        expected[t] = pmf_remaining.mean()\n\n    return expected";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">expected</span> <span class="o">=</span> <span class="n">expected_remaining</span><span class="p">(</span><span class="n">pmf_durations</span><span class="p">)</span>
<span class="n">expected</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>36    3.262344
37    2.388225
38    1.531935
39    0.659377
40    0.899135
41    0.803468
42    0.651952
43    0.627119
dtype: float64
</pre></div>
</div>
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 72;
                var nbb_unformatted_code = "expected = expected_remaining(pmf_durations)\nexpected";
                var nbb_formatted_code = "expected = expected_remaining(pmf_durations)\nexpected";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">21</span><span class="p">):</span>
    <span class="n">sample</span> <span class="o">=</span> <span class="n">resample_rows_weighted</span><span class="p">(</span><span class="n">live</span><span class="p">,</span> <span class="s2">&quot;finalwgt&quot;</span><span class="p">)</span>
    <span class="n">pmf_durations</span> <span class="o">=</span> <span class="n">Pmf</span><span class="o">.</span><span class="n">from_seq</span><span class="p">(</span><span class="n">sample</span><span class="p">[</span><span class="s2">&quot;prglngth&quot;</span><span class="p">])</span>
    <span class="n">expected</span> <span class="o">=</span> <span class="n">expected_remaining</span><span class="p">(</span><span class="n">pmf_durations</span><span class="p">)</span>
    <span class="n">expected</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;C0&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>

<span class="n">decorate</span><span class="p">(</span>
    <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;Weeks of pregnancy&quot;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;Expected remaining time (weeks)&quot;</span><span class="p">,</span> <span class="n">ylim</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/1dd021671dc270ce355324d2ff17afaa4b781f2c0042e800e164080602e84124.png" src="_images/1dd021671dc270ce355324d2ff17afaa4b781f2c0042e800e164080602e84124.png" />
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 73;
                var nbb_unformatted_code = "for i in range(21):\n    sample = resample_rows_weighted(live, \"finalwgt\")\n    pmf_durations = Pmf.from_seq(sample[\"prglngth\"])\n    expected = expected_remaining(pmf_durations)\n    expected.plot(color=\"C0\", alpha=0.1)\n\ndecorate(\n    xlabel=\"Weeks of pregnancy\", ylabel=\"Expected remaining time (weeks)\", ylim=[0, 3.5]\n)";
                var nbb_formatted_code = "for i in range(21):\n    sample = resample_rows_weighted(live, \"finalwgt\")\n    pmf_durations = Pmf.from_seq(sample[\"prglngth\"])\n    expected = expected_remaining(pmf_durations)\n    expected.plot(color=\"C0\", alpha=0.1)\n\ndecorate(\n    xlabel=\"Weeks of pregnancy\", ylabel=\"Expected remaining time (weeks)\", ylim=[0, 3.5]\n)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
</section>
<section id="glossary">
<h2><span class="section-number">13.10. </span>Glossary<a class="headerlink" href="#glossary" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p><strong>survival analysis</strong>: A set of methods for describing and predicting lifetimes, or more generally time until an event occurs.</p></li>
<li><p><strong>survival function</strong>: A function that maps from a time, <span class="math notranslate nohighlight">\(t\)</span>, to the probability of surviving past <span class="math notranslate nohighlight">\(t\)</span>.</p></li>
<li><p><strong>hazard function</strong>: A function that maps from <span class="math notranslate nohighlight">\(t\)</span> to the fraction of people alive until <span class="math notranslate nohighlight">\(t\)</span> who die at <span class="math notranslate nohighlight">\(t\)</span>.</p></li>
<li><p><strong>Kaplan-Meier estimation</strong>: An algorithm for estimating hazard and survival functions.</p></li>
<li><p><strong>cohort</strong>: a group of subjects defined by an event, like date of birth, in a particular interval of time.</p></li>
<li><p><strong>cohort effect</strong>: a difference between cohorts.</p></li>
<li><p><strong>NBUE</strong>: A property of expected remaining lifetime, “New better than used in expectation.”</p></li>
<li><p><strong>UBNE</strong>: A property of expected remaining lifetime, “Used better than new in expectation.”</p></li>
</ul>
</section>
<section id="exercises">
<h2><span class="section-number">13.11. </span>Exercises<a class="headerlink" href="#exercises" title="Link to this heading">#</a></h2>
<section id="exercise">
<h3><span class="section-number">13.11.1. </span>Exercise<a class="headerlink" href="#exercise" title="Link to this heading">#</a></h3>
<p>We can use the methods in this chapter to estimate hazard and survival functions for the duration of a marriage.
To keep things simple, we’ll consider only first marriages, and we’ll focus on divorce as the endpoint, rather than separation or death.</p>
<p>In the NSFG data, the <code class="docutils literal notranslate"><span class="pre">cmdivorcx</span></code> column contains the date of divorce for each respondent’s first marriage, if applicable, encoded in century-months.</p>
<p>Compute the duration of marriages that have ended in divorce, and the duration, so far, of marriages that are ongoing.</p>
<ul class="simple">
<li><p>For complete cases, you can compute the elapsed time between <code class="docutils literal notranslate"><span class="pre">cmdivorcx</span></code> and <code class="docutils literal notranslate"><span class="pre">cmmarrhx</span></code>. If both values are valid – not <code class="docutils literal notranslate"><span class="pre">NaN</span></code> – that means the respondent’s first marriage ended in divorce.</p></li>
<li><p>To identify ongoing cases, you should select people who have only married once and who are still married. You can use <code class="docutils literal notranslate"><span class="pre">fmarno</span></code>, which records the number of times each respondent has married, and <code class="docutils literal notranslate"><span class="pre">fmarital</span></code>, which encodes marital status – the value 1 indicates that the respondent is married.</p></li>
</ul>
<p>In some cases the values of these variables are only approximate, so you might find a small number of negative differences, but they should not be more than one year.</p>
<p>Estimate the hazard and survival function for the duration of marriage.
Plot the cumulative hazard function – when is the danger of divorce highest?
Plot the survival function – what fraction of marriages end in divorce?</p>
<div class="cell tag_remove-print docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Use a single resampling of the data</span>

<span class="n">sample</span> <span class="o">=</span> <span class="n">resample_cycles</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 74;
                var nbb_unformatted_code = "# Use a single resampling of the data\n\nsample = resample_cycles(resp)";
                var nbb_formatted_code = "# Use a single resampling of the data\n\nsample = resample_cycles(resp)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
</section>
<section id="id1">
<h3><span class="section-number">13.11.2. </span>Exercise<a class="headerlink" href="#id1" title="Link to this heading">#</a></h3>
<p>In 2012, a team of demographers at the University of Southern California estimated life expectancy for people born in Sweden in the early 1800s and 1900s.
For ages from 0 to 91 years, they estimated the age-specific mortality rate, which is the fraction of people who survive until a certain age and then die at that age – which you might recognize as the hazard function.</p>
<p>I used an online graph digitizer to get the data from the figure in their paper and store it in a CSV file.
Instructions for downloading the data are in the notebook for this chapter.</p>
<p>Data source: Beltrán-Sánchez, H., Crimmins, E. M., &amp; Finch, C. E. (2012). Early cohort mortality predicts the rate of aging in the cohort: a historical analysis. <em>Journal of developmental origins of health and disease</em>, 3(5), 380-386.</p>
<p>The following cell downloads the data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">download</span><span class="p">(</span>
    <span class="s2">&quot;https://github.com/AllenDowney/ThinkStats/raw/v3/data/mortality_rates_beltran2012.csv&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 83;
                var nbb_unformatted_code = "download(\n    \"https://github.com/AllenDowney/ThinkStats/raw/v3/data/mortality_rates_beltran2012.csv\"\n)";
                var nbb_formatted_code = "download(\n    \"https://github.com/AllenDowney/ThinkStats/raw/v3/data/mortality_rates_beltran2012.csv\"\n)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>We can load the data like this.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mortality</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;mortality_rates_beltran2012.csv&quot;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 84;
                var nbb_unformatted_code = "mortality = pd.read_csv(\"mortality_rates_beltran2012.csv\", header=[0, 1]).dropna()";
                var nbb_formatted_code = "mortality = pd.read_csv(\"mortality_rates_beltran2012.csv\", header=[0, 1]).dropna()";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>The following function interpolates the data to make a hazard function with approximate mortality rates for each age from 0 to 99.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">interp1d</span>
<span class="kn">from</span> <span class="nn">empiricaldist</span> <span class="kn">import</span> <span class="n">Hazard</span>


<span class="k">def</span> <span class="nf">make_hazard</span><span class="p">(</span><span class="n">ages</span><span class="p">,</span> <span class="n">rates</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Make a Hazard function by interpolating a Series.</span>

<span class="sd">    series: Series</span>

<span class="sd">    returns: Hazard</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">interp</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">ages</span><span class="p">,</span> <span class="n">rates</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="s2">&quot;extrapolate&quot;</span><span class="p">)</span>
    <span class="n">xs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
    <span class="n">ys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">interp</span><span class="p">(</span><span class="n">xs</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">Hazard</span><span class="p">(</span><span class="n">ys</span><span class="p">,</span> <span class="n">xs</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 85;
                var nbb_unformatted_code = "from scipy.interpolate import interp1d\nfrom empiricaldist import Hazard\n\n\ndef make_hazard(ages, rates):\n    \"\"\"Make a Hazard function by interpolating a Series.\n\n    series: Series\n\n    returns: Hazard\n    \"\"\"\n    interp = interp1d(ages, rates, fill_value=\"extrapolate\")\n    xs = np.arange(0, 100)\n    ys = np.exp(interp(xs))\n    return Hazard(ys, xs)";
                var nbb_formatted_code = "from scipy.interpolate import interp1d\nfrom empiricaldist import Hazard\n\n\ndef make_hazard(ages, rates):\n    \"\"\"Make a Hazard function by interpolating a Series.\n\n    series: Series\n\n    returns: Hazard\n    \"\"\"\n    interp = interp1d(ages, rates, fill_value=\"extrapolate\")\n    xs = np.arange(0, 100)\n    ys = np.exp(interp(xs))\n    return Hazard(ys, xs)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>Now we can make a <code class="docutils literal notranslate"><span class="pre">Hazard</span></code> object like this.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ages</span> <span class="o">=</span> <span class="n">mortality</span><span class="p">[</span><span class="s2">&quot;1800&quot;</span><span class="p">,</span> <span class="s2">&quot;X&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="n">rates</span> <span class="o">=</span> <span class="n">mortality</span><span class="p">[</span><span class="s2">&quot;1800&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="n">hazard</span> <span class="o">=</span> <span class="n">make_hazard</span><span class="p">(</span><span class="n">ages</span><span class="p">,</span> <span class="n">rates</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 86;
                var nbb_unformatted_code = "ages = mortality[\"1800\", \"X\"].values\nrates = mortality[\"1800\", \"Y\"].values\nhazard = make_hazard(ages, rates)";
                var nbb_formatted_code = "ages = mortality[\"1800\", \"X\"].values\nrates = mortality[\"1800\", \"Y\"].values\nhazard = make_hazard(ages, rates)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>Here’s what the mortality rates look like.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hazard</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>

<span class="n">decorate</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;Age (years)&quot;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;Probability&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/627e081018b5c19b3f07c3c476361f867c27407d92120a730b0ac509626975a7.png" src="_images/627e081018b5c19b3f07c3c476361f867c27407d92120a730b0ac509626975a7.png" />
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 87;
                var nbb_unformatted_code = "hazard.plot()\n\ndecorate(xlabel=\"Age (years)\", ylabel=\"Probability\")";
                var nbb_formatted_code = "hazard.plot()\n\ndecorate(xlabel=\"Age (years)\", ylabel=\"Probability\")";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>Use <code class="docutils literal notranslate"><span class="pre">make_surv</span></code> to make a survival function based on these rates, and <code class="docutils literal notranslate"><span class="pre">make_cdf</span></code> to compute the corresponding CDF.
Plot the results.</p>
<p>Then use <code class="docutils literal notranslate"><span class="pre">make_pmf</span></code> to make the <code class="docutils literal notranslate"><span class="pre">PMF</span></code> of the distribution of lifetimes and plot it.
Finally, use <code class="docutils literal notranslate"><span class="pre">compute_pmf_remaining</span></code> to compute the average remaining lifetime at each age from 0 to 99.
Plot the result.</p>
<p>In the remaining lifetime, you should see a counterintuitive pattern – for the first few years of life, remaining lifetime increases.
Because infant mortality was so high in the early 1800s, an older child was expected to live longer than a younger child.
After about age 5, life expectancy returns to the pattern we expect – younger people are expected to live longer than old people.</p>
<p>If you are interested in this topic, you might like Chapter 5 of my book, <em>Probably Overthinking It</em>, which is about this and other counterintuitive results from many areas of statistics.</p>
<p>Available from <a class="reference external" href="https://probablyoverthinking.it">https://probablyoverthinking.it</a>.</p>
<p><a class="reference external" href="https://allendowney.github.io/ThinkStats/index.html">Think Stats: Exploratory Data Analysis in Python, 3rd Edition</a></p>
<p>Copyright 2024 <a class="reference external" href="https://allendowney.com">Allen B. Downey</a></p>
<p>Code license: <a class="reference external" href="https://mit-license.org/">MIT License</a></p>
<p>Text license: <a class="reference external" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International</a></p>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="chap12.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title"><span class="section-number">12. </span>Time series analysis</p>
      </div>
    </a>
    <a class="right-next"
       href="chap14.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title"><span class="section-number">14. </span>Analytic methods</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#survival-function">13.1. Survival Function</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#hazard-function">13.2. Hazard Function</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#marriage-data">13.3. Marriage Data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#weighted-resampling">13.4. Weighted Resampling</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#estimating-survival-functions">13.5. Estimating Survival Functions</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#estimating-the-survival-function">13.6. Estimating the Survival Function</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#lifelines">13.7. Lifelines</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#confidence-intervals">13.8. Confidence Intervals</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#expected-remaining-lifetime">13.9. Expected remaining lifetime</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#glossary">13.10. Glossary</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercises">13.11. Exercises</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise">13.11.1. Exercise</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">13.11.2. Exercise</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Allen B. Downey
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
<div class="extra_footer">
  <div style="text-align: left;">
  <a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">
    <img alt="Creative Commons License" style="border-width:0"
         src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" />
  </a>
  <br />
  This work is licensed under a
  <a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">
    Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License
  </a>.
</div>

</div>
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=3ee479438cf8b5e0d341"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=3ee479438cf8b5e0d341"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>