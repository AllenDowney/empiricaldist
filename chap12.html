
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>12. Time series analysis &#8212; Think Stats</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=3ee479438cf8b5e0d341" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=3ee479438cf8b5e0d341" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=3ee479438cf8b5e0d341" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=3ee479438cf8b5e0d341" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css?v=a3416100" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css?v=be8a1c11" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-design.min.css?v=87e54e7c" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=3ee479438cf8b5e0d341" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=3ee479438cf8b5e0d341" />
  <script src="_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=3ee479438cf8b5e0d341"></script>

    <script src="_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js?v=36754332"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]]}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'chap12';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="13. Survival analysis" href="chap13.html" />
    <link rel="prev" title="11. Regression" href="chap11.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="index.html">
  
  
  
  
  
  
    <p class="title logo__title">Think Stats</p>
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="index.html">
                    Think Stats, 3rd edition
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Front Matter</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="chap00.html">Preface</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Chapters</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="chap01.html">1. Exploratory Data Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap02.html">2. Distributions</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap03.html">3. Probability Mass Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap04.html">4. Cumulative Distribution Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap05.html">5. Modeling Distributions</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap06.html">6. Probability Density Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap07.html">7. Relationships between variables</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap08.html">8. Estimation</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap09.html">9. Hypothesis Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap10.html">10. Least Squares</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap11.html">11. Regression</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">12. Time series analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap13.html">13. Survival analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap14.html">14. Analytic methods</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Examples</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="ripoff_etf.html">Rip-off ETF?</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">


<a href="https://github.com/AllenDowney/ThinkStats/tree/v3" target="_blank"
   class="btn btn-sm btn-source-repository-button"
   title="Source repository"
   data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>

</a>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/chap12.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Time series analysis</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#electricity">12.1. Electricity</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#decomposition">12.2. Decomposition</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#prediction">12.3. Prediction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#multiplicative-model">12.4. Multiplicative Model</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#autoregression">12.5. Autoregression</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#moving-average">12.6. Moving Average</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#retrodiction-with-autoregression">12.7. Retrodiction with Autoregression</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#arima">12.8. ARIMA</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#prediction-with-arima">12.9. Prediction with ARIMA</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#glossary">12.10. Glossary</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercises">12.11. Exercises</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise">12.11.1. Exercise</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">12.12. Exercise</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">12.13. Exercise</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="time-series-analysis">
<h1><span class="section-number">12. </span>Time series analysis<a class="headerlink" href="#time-series-analysis" title="Link to this heading">#</a></h1>
<p>A <strong>time series</strong> is a sequence of measurements from a system that varies in time.
Many of the tools we used in previous chapters, like linear regression, can also be used with time series data.
But there are additional methods that are particularly useful for this kind of data.</p>
<p>As examples, we’ll look at two datasets, renewable electricity generation in the United States from 2001 to 2024, and weather data over the same interval.
We will develop methods to decompose a time series into a long-term trend and a repeated seasonal component.
We’ll use linear regression models to fit and forecast trends.
And we’ll try out a widely-used model for analyzing time series data, with the formal name “autoregressive integrated moving average” and the easier-to-say acronym ARIMA.</p>
<p><a class="reference external" href="https://colab.research.google.com/github/AllenDowney/ThinkStats/blob/v3/nb/chap12.ipynb">Click here to run this notebook on Colab</a>.</p>
<div class="cell tag_remove-print tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> nb_black
<span class="o">%</span><span class="k">load_ext</span> autoreload
<span class="o">%</span><span class="k">autoreload</span> 2
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 1;
                var nbb_unformatted_code = "%load_ext nb_black\n%load_ext autoreload\n%autoreload 2";
                var nbb_formatted_code = "%load_ext nb_black\n%load_ext autoreload\n%autoreload 2";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</details>
</div>
<div class="cell tag_remove-print tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">basename</span><span class="p">,</span> <span class="n">exists</span>


<span class="k">def</span> <span class="nf">download</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">basename</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">urllib.request</span> <span class="kn">import</span> <span class="n">urlretrieve</span>

        <span class="n">local</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">urlretrieve</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Downloaded &quot;</span> <span class="o">+</span> <span class="n">local</span><span class="p">)</span>


<span class="n">download</span><span class="p">(</span><span class="s2">&quot;https://github.com/AllenDowney/ThinkStats/raw/v3/nb/thinkstats.py&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 2;
                var nbb_unformatted_code = "from os.path import basename, exists\n\n\ndef download(url):\n    filename = basename(url)\n    if not exists(filename):\n        from urllib.request import urlretrieve\n\n        local, _ = urlretrieve(url, filename)\n        print(\"Downloaded \" + local)\n\n\ndownload(\"https://github.com/AllenDowney/ThinkStats/raw/v3/nb/thinkstats.py\")";
                var nbb_formatted_code = "from os.path import basename, exists\n\n\ndef download(url):\n    filename = basename(url)\n    if not exists(filename):\n        from urllib.request import urlretrieve\n\n        local, _ = urlretrieve(url, filename)\n        print(\"Downloaded \" + local)\n\n\ndownload(\"https://github.com/AllenDowney/ThinkStats/raw/v3/nb/thinkstats.py\")";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</details>
</div>
<div class="cell tag_remove-print tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">empiricaldist</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="o">!</span>pip<span class="w"> </span>install<span class="w"> </span>empiricaldist
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 3;
                var nbb_unformatted_code = "try:\n    import empiricaldist\nexcept ImportError:\n    !pip install empiricaldist";
                var nbb_formatted_code = "try:\n    import empiricaldist\nexcept ImportError:\n    !pip install empiricaldist";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</details>
</div>
<div class="cell tag_remove-print tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="kn">from</span> <span class="nn">thinkstats</span> <span class="kn">import</span> <span class="n">decorate</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 4;
                var nbb_unformatted_code = "import numpy as np\nimport pandas as pd\nimport matplotlib.pyplot as plt\n\nfrom thinkstats import decorate";
                var nbb_formatted_code = "import numpy as np\nimport pandas as pd\nimport matplotlib.pyplot as plt\n\nfrom thinkstats import decorate";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</details>
</div>
<section id="electricity">
<h2><span class="section-number">12.1. </span>Electricity<a class="headerlink" href="#electricity" title="Link to this heading">#</a></h2>
<p>As an example of time-series data, we’ll use a dataset from the U.S. Energy Information Administration – it includes total electricity generation per month from renewable sources from 2021 to 2024.
Instructions for downloading the data are in the notebook for this chapter.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># The following cell downloads the data, which I downloaded September 17, 2024</span>
<span class="c1"># from https://www.eia.gov/electricity/data/browser/</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 5;
                var nbb_unformatted_code = "# The following cell downloads the data, which I downloaded September 17, 2024\n# from https://www.eia.gov/electricity/data/browser/";
                var nbb_formatted_code = "# The following cell downloads the data, which I downloaded September 17, 2024\n# from https://www.eia.gov/electricity/data/browser/";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;Net_generation_for_all_sectors.csv&quot;</span>
<span class="n">download</span><span class="p">(</span><span class="s2">&quot;https://github.com/AllenDowney/ThinkStats/raw/v3/data/&quot;</span> <span class="o">+</span> <span class="n">filename</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 6;
                var nbb_unformatted_code = "filename = \"Net_generation_for_all_sectors.csv\"\ndownload(\"https://github.com/AllenDowney/ThinkStats/raw/v3/data/\" + filename)";
                var nbb_formatted_code = "filename = \"Net_generation_for_all_sectors.csv\"\ndownload(\"https://github.com/AllenDowney/ThinkStats/raw/v3/data/\" + filename)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>After loading the data, we have make some transformations to get it into a format that’s easy to work with.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">elec</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;Net_generation_for_all_sectors.csv&quot;</span><span class="p">,</span> <span class="n">skiprows</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
    <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;units&quot;</span><span class="p">,</span> <span class="s2">&quot;source key&quot;</span><span class="p">])</span>
    <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;description&quot;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
    <span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 7;
                var nbb_unformatted_code = "elec = (\n    pd.read_csv(\"Net_generation_for_all_sectors.csv\", skiprows=4)\n    .drop(columns=[\"units\", \"source key\"])\n    .set_index(\"description\")\n    .replace(\"--\", np.nan)\n    .transpose()\n    .astype(float)\n)";
                var nbb_formatted_code = "elec = (\n    pd.read_csv(\"Net_generation_for_all_sectors.csv\", skiprows=4)\n    .drop(columns=[\"units\", \"source key\"])\n    .set_index(\"description\")\n    .replace(\"--\", np.nan)\n    .transpose()\n    .astype(float)\n)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>Each column is a sequence of monthly totals in gigawatt-hours (GWh).
Here are the column labels, showing the different sources of electricity, or “sectors”.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">elec</span><span class="o">.</span><span class="n">columns</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Index([&#39;Net generation for all sectors&#39;, &#39;United States&#39;,
       &#39;United States : all fuels (utility-scale)&#39;, &#39;United States : nuclear&#39;,
       &#39;United States : conventional hydroelectric&#39;,
       &#39;United States : other renewables&#39;, &#39;United States : wind&#39;,
       &#39;United States : all utility-scale solar&#39;, &#39;United States : geothermal&#39;,
       &#39;United States : biomass&#39;,
       &#39;United States : hydro-electric pumped storage&#39;,
       &#39;United States : all solar&#39;,
       &#39;United States : small-scale solar photovoltaic&#39;],
      dtype=&#39;object&#39;, name=&#39;description&#39;)
</pre></div>
</div>
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 8;
                var nbb_unformatted_code = "elec.columns";
                var nbb_formatted_code = "elec.columns";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>The labels in the index are strings indicating months and years.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">elec</span><span class="o">.</span><span class="n">index</span><span class="p">[:</span><span class="mi">6</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Index([&#39;Jan 2001&#39;, &#39;Feb 2001&#39;, &#39;Mar 2001&#39;, &#39;Apr 2001&#39;, &#39;May 2001&#39;, &#39;Jun 2001&#39;], dtype=&#39;object&#39;)
</pre></div>
</div>
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 9;
                var nbb_unformatted_code = "elec.index[:6]";
                var nbb_formatted_code = "elec.index[:6]";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>It will be easier to work with this data if we replace these strings with Pandas <code class="docutils literal notranslate"><span class="pre">Timestamp</span></code> objects.
We can use the <code class="docutils literal notranslate"><span class="pre">date_range</span></code> function to generate a sequence of <code class="docutils literal notranslate"><span class="pre">Timestamp</span></code> objects, starting in January 2021 with the frequency code <code class="docutils literal notranslate"><span class="pre">&quot;M&quot;</span></code>, which stands for “monthly”.</p>
<p>TODO: Update this when Colab gets to Pandas 2.2.2 … frequency code <code class="docutils literal notranslate"><span class="pre">&quot;ME&quot;</span></code>, which stands for “month end”, which means that it fills in the last day of each month.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">elec</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="s2">&quot;2001-01&quot;</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">elec</span><span class="p">),</span> <span class="n">freq</span><span class="o">=</span><span class="s2">&quot;M&quot;</span><span class="p">)</span>
<span class="n">elec</span><span class="o">.</span><span class="n">index</span><span class="p">[:</span><span class="mi">6</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/tmp/ipykernel_851943/673247472.py:1: FutureWarning: &#39;M&#39; is deprecated and will be removed in a future version, please use &#39;ME&#39; instead.
  elec.index = pd.date_range(start=&quot;2001-01&quot;, periods=len(elec), freq=&quot;M&quot;)
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DatetimeIndex([&#39;2001-01-31&#39;, &#39;2001-02-28&#39;, &#39;2001-03-31&#39;, &#39;2001-04-30&#39;,
               &#39;2001-05-31&#39;, &#39;2001-06-30&#39;],
              dtype=&#39;datetime64[ns]&#39;, freq=&#39;ME&#39;)
</pre></div>
</div>
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 10;
                var nbb_unformatted_code = "elec.index = pd.date_range(start=\"2001-01\", periods=len(elec), freq=\"M\")\nelec.index[:6]";
                var nbb_formatted_code = "elec.index = pd.date_range(start=\"2001-01\", periods=len(elec), freq=\"M\")\nelec.index[:6]";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>As a first example, we’ll look at how electricity generation from nuclear reactors has changed over this interval, and we’ll decompose the time series into a long-term trend and a periodic component.</p>
</section>
<section id="decomposition">
<h2><span class="section-number">12.2. </span>Decomposition<a class="headerlink" href="#decomposition" title="Link to this heading">#</a></h2>
<p>Here are monthly totals of electricity generation from nuclear reactors in the United States from January 2001 to June 2024.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nuclear</span> <span class="o">=</span> <span class="n">elec</span><span class="p">[</span><span class="s2">&quot;United States : nuclear&quot;</span><span class="p">]</span>
<span class="n">nuclear</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;nuclear&quot;</span><span class="p">)</span>

<span class="n">decorate</span><span class="p">(</span><span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;GWh&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/250021343680b07056dccb7318db712a4bf6cf18fda96ed81c09bce4e19ef916.png" src="_images/250021343680b07056dccb7318db712a4bf6cf18fda96ed81c09bce4e19ef916.png" />
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 11;
                var nbb_unformatted_code = "nuclear = elec[\"United States : nuclear\"]\nnuclear.plot(label=\"nuclear\")\n\ndecorate(ylabel=\"GWh\")";
                var nbb_formatted_code = "nuclear = elec[\"United States : nuclear\"]\nnuclear.plot(label=\"nuclear\")\n\ndecorate(ylabel=\"GWh\")";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>It looks like there are some long-term increases and decreases, but they are hard to see clearly because there are large variations from month to month.
To see the long-term trend more clearly, we can use the <code class="docutils literal notranslate"><span class="pre">rolling</span></code> method, which computes a “rolling average”.
The <code class="docutils literal notranslate"><span class="pre">window=12</span></code> argument means it should select overlapping intervals of 12 months, so the first interval contains 12 measurements starting with the first, the second interval contains 12 measurements starting with the second, and so on.
For each interval, we compute the mean of the measurements.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">trend</span> <span class="o">=</span> <span class="n">nuclear</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 12;
                var nbb_unformatted_code = "trend = nuclear.rolling(window=12).mean()";
                var nbb_formatted_code = "trend = nuclear.rolling(window=12).mean()";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>Here’s what the results look like, along with the original data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nuclear</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;nuclear&quot;</span><span class="p">)</span>
<span class="n">trend</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;trend&quot;</span><span class="p">)</span>
<span class="n">decorate</span><span class="p">(</span><span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;GWh&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/f65c1127364cdc823c93b28d8713a15057e52dd076262faf18ee21d9e5efa60c.png" src="_images/f65c1127364cdc823c93b28d8713a15057e52dd076262faf18ee21d9e5efa60c.png" />
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 13;
                var nbb_unformatted_code = "nuclear.plot(label=\"nuclear\")\ntrend.plot(label=\"trend\")\ndecorate(ylabel=\"GWh\")";
                var nbb_formatted_code = "nuclear.plot(label=\"nuclear\")\ntrend.plot(label=\"trend\")\ndecorate(ylabel=\"GWh\")";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>The trend is still quite variable.
We could smooth it more by using a longer window, but we’ll stick with the 12-month window for now.</p>
<p>If we subtract the trend from the original data, the result is a “detrended” time series, which means that the long-term mean is close to constant.
Here’s what it looks like.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">detrended</span> <span class="o">=</span> <span class="p">(</span><span class="n">nuclear</span> <span class="o">-</span> <span class="n">trend</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
<span class="n">detrended</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;detrended&quot;</span><span class="p">)</span>
<span class="n">decorate</span><span class="p">(</span><span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;GWh&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/22cab2abe35100c119e48b57e2f1fe84fad2937d2c97fda212678d3e749a9c25.png" src="_images/22cab2abe35100c119e48b57e2f1fe84fad2937d2c97fda212678d3e749a9c25.png" />
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 14;
                var nbb_unformatted_code = "detrended = (nuclear - trend).dropna()\ndetrended.plot(label=\"detrended\")\ndecorate(ylabel=\"GWh\")";
                var nbb_formatted_code = "detrended = (nuclear - trend).dropna()\ndetrended.plot(label=\"detrended\")\ndecorate(ylabel=\"GWh\")";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>It looks like there is a repeating annual pattern, which makes sense because demand for electricity varies from one season to another, as it is used to generate heat in the winter and run air conditioning in the summer.
To describe this annual pattern we can group the data by month and compute average production.
Here’s what the monthly averages look like.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">monthly_averages</span> <span class="o">=</span> <span class="n">detrended</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">detrended</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">monthly_averages</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;monthly average&quot;</span><span class="p">)</span>
<span class="n">decorate</span><span class="p">(</span><span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;GWh&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/adeb792531b4bae4bcedb27a3097c3fc578863c5769f8fcd8c4ebcd1e6c4062f.png" src="_images/adeb792531b4bae4bcedb27a3097c3fc578863c5769f8fcd8c4ebcd1e6c4062f.png" />
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 15;
                var nbb_unformatted_code = "monthly_averages = detrended.groupby(detrended.index.month).mean()\nmonthly_averages.plot(label=\"monthly average\")\ndecorate(ylabel=\"GWh\")";
                var nbb_formatted_code = "monthly_averages = detrended.groupby(detrended.index.month).mean()\nmonthly_averages.plot(label=\"monthly average\")\ndecorate(ylabel=\"GWh\")";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>Electricity production is highest during the coldest and warmest months.</p>
<p>We can use <code class="docutils literal notranslate"><span class="pre">monthly_averages</span></code> to construct the seasonal component of the data, which is a series the same length as <code class="docutils literal notranslate"><span class="pre">nuclear</span></code>, where the element for each month is the monthly average for that month.
Here’s what it looks like.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">seasonal</span> <span class="o">=</span> <span class="n">monthly_averages</span><span class="p">[</span><span class="n">nuclear</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span><span class="p">]</span>
<span class="n">seasonal</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">nuclear</span><span class="o">.</span><span class="n">index</span>
<span class="n">seasonal</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">decorate</span><span class="p">(</span><span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;GWh&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/6bf4661513e29f4ba28930abc6b45a04d82b038fa904fa9a7479d7526fc6d759.png" src="_images/6bf4661513e29f4ba28930abc6b45a04d82b038fa904fa9a7479d7526fc6d759.png" />
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 16;
                var nbb_unformatted_code = "seasonal = monthly_averages[nuclear.index.month]\nseasonal.index = nuclear.index\nseasonal.plot()\ndecorate(ylabel=\"GWh\")";
                var nbb_formatted_code = "seasonal = monthly_averages[nuclear.index.month]\nseasonal.index = nuclear.index\nseasonal.plot()\ndecorate(ylabel=\"GWh\")";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>Each 12-month period is identical to the others.</p>
<p>The sum of the trend and the seasonal component represents the expected value for each month.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">expected</span> <span class="o">=</span> <span class="n">trend</span> <span class="o">+</span> <span class="n">seasonal</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 17;
                var nbb_unformatted_code = "expected = trend + seasonal";
                var nbb_formatted_code = "expected = trend + seasonal";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>Here’s what it looks like compared to the original series.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nuclear</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;nuclear&quot;</span><span class="p">)</span>
<span class="n">expected</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;0.8&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;expected&quot;</span><span class="p">)</span>
<span class="n">decorate</span><span class="p">(</span><span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;GWh&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/b28a819f0f3fba169eace29e095cb661a9a323b4c9d8fb9ca7c9804a7194021b.png" src="_images/b28a819f0f3fba169eace29e095cb661a9a323b4c9d8fb9ca7c9804a7194021b.png" />
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 18;
                var nbb_unformatted_code = "nuclear.plot(label=\"nuclear\")\nexpected.plot(color=\"0.8\", label=\"expected\")\ndecorate(ylabel=\"GWh\")";
                var nbb_formatted_code = "nuclear.plot(label=\"nuclear\")\nexpected.plot(color=\"0.8\", label=\"expected\")\ndecorate(ylabel=\"GWh\")";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>If we subtract this sum from the original signal, the result is the residual component, which represents the departure from the expected value for each month.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">resid</span> <span class="o">=</span> <span class="n">nuclear</span> <span class="o">-</span> <span class="n">expected</span>
<span class="n">resid</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;residual&quot;</span><span class="p">)</span>
<span class="n">decorate</span><span class="p">(</span><span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;GWh&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/7b0e1d6dd5008602487681b72deacadc987bc7dc733729c5507a4d6ec442e294.png" src="_images/7b0e1d6dd5008602487681b72deacadc987bc7dc733729c5507a4d6ec442e294.png" />
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 19;
                var nbb_unformatted_code = "resid = nuclear - expected\nresid.plot(label=\"residual\")\ndecorate(ylabel=\"GWh\")";
                var nbb_formatted_code = "resid = nuclear - expected\nresid.plot(label=\"residual\")\ndecorate(ylabel=\"GWh\")";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>We can think of the residual as the sum of everything in the world that affects energy production, but is not explained by the long-term trend or the seasonal component.
Among other things, that sum includes weather, equipment that’s down for maintenance, and changes in demand due to specific events.
Since the residual is the sum of many unpredictable, and sometimes unknowable, factors, we often treat it as a random quantity.</p>
<p>Here’s what the distribution of the residuals look like.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">thinkstats</span> <span class="kn">import</span> <span class="n">plot_kde</span>

<span class="n">plot_kde</span><span class="p">(</span><span class="n">resid</span><span class="o">.</span><span class="n">dropna</span><span class="p">())</span>
<span class="n">decorate</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;Residual (GWh)&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/1923f3d97fa67bd15187bac8c4d11c6d1c9a49ba6a85a60676def865eac082e6.png" src="_images/1923f3d97fa67bd15187bac8c4d11c6d1c9a49ba6a85a60676def865eac082e6.png" />
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 20;
                var nbb_unformatted_code = "from thinkstats import plot_kde\n\nplot_kde(resid.dropna())\ndecorate(xlabel=\"Residual (GWh)\")";
                var nbb_formatted_code = "from thinkstats import plot_kde\n\nplot_kde(resid.dropna())\ndecorate(xlabel=\"Residual (GWh)\")";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>It resembles the bell curve of the normal distribution, which is consistent with the assumption that it is the sum of many random contributions.</p>
<p>To describe how well this model describes the original series, we can compute the coefficient of determination, which indicates how much smaller the variance of the residuals is, compared to the variance of the original series.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rsquared</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">resid</span><span class="o">.</span><span class="n">var</span><span class="p">()</span> <span class="o">/</span> <span class="n">nuclear</span><span class="o">.</span><span class="n">var</span><span class="p">()</span>
<span class="n">rsquared</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.9054559977517084
</pre></div>
</div>
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 21;
                var nbb_unformatted_code = "rsquared = 1 - resid.var() / nuclear.var()\nrsquared";
                var nbb_formatted_code = "rsquared = 1 - resid.var() / nuclear.var()\nrsquared";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>The <span class="math notranslate nohighlight">\(R^2\)</span> value is about 0.92, which means that the long-term trend and seasonal component account for 92% of the variability in the series.
This coefficient of determination is substantially higher than the ones we saw in the previous chapter, but that’s common with time series data – especially in a case like this where we’ve constructed the model to resemble the data.</p>
<p>The process we’ve just walked through is called “seasonal decomposition”.
StatsModels provides a function that does it, called <code class="docutils literal notranslate"><span class="pre">seasonal_decompose</span></code>.</p>
<p>It takes the original series as an argument and a string that specifies the type of model.
What we just computed is the additive model, because the series is decomposed into the sum of a trend, seasonal component, and residual.
We’ll see the multiplicative model soon.
The third argument is the period, which is the length of one seasonal cycle.
In this dataset, we assume that the period of the seasonal component is 12 months.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">statsmodels.tsa.seasonal</span> <span class="kn">import</span> <span class="n">seasonal_decompose</span>

<span class="n">decomposition</span> <span class="o">=</span> <span class="n">seasonal_decompose</span><span class="p">(</span><span class="n">nuclear</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="s2">&quot;additive&quot;</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 22;
                var nbb_unformatted_code = "from statsmodels.tsa.seasonal import seasonal_decompose\n\ndecomposition = seasonal_decompose(nuclear, model=\"additive\", period=12)";
                var nbb_formatted_code = "from statsmodels.tsa.seasonal import seasonal_decompose\n\ndecomposition = seasonal_decompose(nuclear, model=\"additive\", period=12)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>The result is an object that contains the three components.
We’ll use the following function to plot them.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot_decomposition</span><span class="p">(</span><span class="n">original</span><span class="p">,</span> <span class="n">decomposition</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">original</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Original&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C0&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Original&quot;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">decomposition</span><span class="o">.</span><span class="n">trend</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Trend&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C1&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Trend&quot;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">decomposition</span><span class="o">.</span><span class="n">seasonal</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Seasonal&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C2&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Seasonal&quot;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">decomposition</span><span class="o">.</span><span class="n">resid</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Residual&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C3&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Residual&quot;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 23;
                var nbb_unformatted_code = "def plot_decomposition(original, decomposition):\n    plt.figure(figsize=(6, 5))\n\n    plt.subplot(4, 1, 1)\n    plt.plot(original, label=\"Original\", color=\"C0\")\n    plt.ylabel(\"Original\")\n\n    plt.subplot(4, 1, 2)\n    plt.plot(decomposition.trend, label=\"Trend\", color=\"C1\")\n    plt.ylabel(\"Trend\")\n\n    plt.subplot(4, 1, 3)\n    plt.plot(decomposition.seasonal, label=\"Seasonal\", color=\"C2\")\n    plt.ylabel(\"Seasonal\")\n\n    plt.subplot(4, 1, 4)\n    plt.plot(decomposition.resid, label=\"Residual\", color=\"C3\")\n    plt.ylabel(\"Residual\")\n\n    plt.tight_layout()";
                var nbb_formatted_code = "def plot_decomposition(original, decomposition):\n    plt.figure(figsize=(6, 5))\n\n    plt.subplot(4, 1, 1)\n    plt.plot(original, label=\"Original\", color=\"C0\")\n    plt.ylabel(\"Original\")\n\n    plt.subplot(4, 1, 2)\n    plt.plot(decomposition.trend, label=\"Trend\", color=\"C1\")\n    plt.ylabel(\"Trend\")\n\n    plt.subplot(4, 1, 3)\n    plt.plot(decomposition.seasonal, label=\"Seasonal\", color=\"C2\")\n    plt.ylabel(\"Seasonal\")\n\n    plt.subplot(4, 1, 4)\n    plt.plot(decomposition.resid, label=\"Residual\", color=\"C3\")\n    plt.ylabel(\"Residual\")\n\n    plt.tight_layout()";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_decomposition</span><span class="p">(</span><span class="n">nuclear</span><span class="p">,</span> <span class="n">decomposition</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/bc2ffeb034fbb8ce231f3d97231f9a944f7a5033a41615c17f8d9b5033b5cfce.png" src="_images/bc2ffeb034fbb8ce231f3d97231f9a944f7a5033a41615c17f8d9b5033b5cfce.png" />
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 24;
                var nbb_unformatted_code = "plot_decomposition(nuclear, decomposition)";
                var nbb_formatted_code = "plot_decomposition(nuclear, decomposition)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>Seasonal decomposition provides some insight into the structure of a time series.
It is also useful for making forecasts.</p>
</section>
<section id="prediction">
<h2><span class="section-number">12.3. </span>Prediction<a class="headerlink" href="#prediction" title="Link to this heading">#</a></h2>
<p>We can use the results from seasonal decomposition to predict the future.
To demonstrate, we’ll use the following function to split the time series into a training series we’ll use to generate predictions and a test series we’ll use to see whether they are accurate.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">split_series</span><span class="p">(</span><span class="n">series</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">60</span><span class="p">):</span>
    <span class="n">training</span> <span class="o">=</span> <span class="n">series</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="o">-</span><span class="n">n</span><span class="p">]</span>
    <span class="n">test</span> <span class="o">=</span> <span class="n">series</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="n">n</span><span class="p">:]</span>
    <span class="k">return</span> <span class="n">training</span><span class="p">,</span> <span class="n">test</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 25;
                var nbb_unformatted_code = "def split_series(series, n=60):\n    training = series.iloc[:-n]\n    test = series.iloc[-n:]\n    return training, test";
                var nbb_formatted_code = "def split_series(series, n=60):\n    training = series.iloc[:-n]\n    test = series.iloc[-n:]\n    return training, test";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>With <code class="docutils literal notranslate"><span class="pre">n=60</span></code>, the duration of the test series is five years, starting in July 2019.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">training</span><span class="p">,</span> <span class="n">test</span> <span class="o">=</span> <span class="n">split_series</span><span class="p">(</span><span class="n">nuclear</span><span class="p">)</span>
<span class="n">test</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Timestamp(&#39;2019-07-31 00:00:00&#39;)
</pre></div>
</div>
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 26;
                var nbb_unformatted_code = "training, test = split_series(nuclear)\ntest.index[0]";
                var nbb_formatted_code = "training, test = split_series(nuclear)\ntest.index[0]";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>Now, suppose it’s June 2019 and you are asked to generate a five-year forecast for electricity production from nuclear generators.
We’ll start with a seasonal decomposition of the training data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">decomposition</span> <span class="o">=</span> <span class="n">seasonal_decompose</span><span class="p">(</span><span class="n">training</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="s2">&quot;additive&quot;</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">trend</span> <span class="o">=</span> <span class="n">decomposition</span><span class="o">.</span><span class="n">trend</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 27;
                var nbb_unformatted_code = "decomposition = seasonal_decompose(training, model=\"additive\", period=12)\ntrend = decomposition.trend";
                var nbb_formatted_code = "decomposition = seasonal_decompose(training, model=\"additive\", period=12)\ntrend = decomposition.trend";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>Now we’ll fit a linear model to the trend.
The dependent variable, <code class="docutils literal notranslate"><span class="pre">months</span></code>, is the number of months from the beginning of the series.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">statsmodels.formula.api</span> <span class="k">as</span> <span class="nn">smf</span>

<span class="n">months</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">trend</span><span class="p">))</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;trend&quot;</span><span class="p">:</span> <span class="n">trend</span><span class="p">,</span> <span class="s2">&quot;months&quot;</span><span class="p">:</span> <span class="n">months</span><span class="p">})</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span><span class="s2">&quot;trend ~ months&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 28;
                var nbb_unformatted_code = "import statsmodels.formula.api as smf\n\nmonths = np.arange(len(trend))\ndata = pd.DataFrame({\"trend\": trend, \"months\": months}).dropna()\nresults = smf.ols(\"trend ~ months\", data=data).fit()";
                var nbb_formatted_code = "import statsmodels.formula.api as smf\n\nmonths = np.arange(len(trend))\ndata = pd.DataFrame({\"trend\": trend, \"months\": months}).dropna()\nresults = smf.ols(\"trend ~ months\", data=data).fit()";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>Here is a summary of the results.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">thinkstats</span> <span class="kn">import</span> <span class="n">display_summary</span>

<span class="n">display_summary</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table class="simpletable">
<tr>
      <td></td>         <th>coef</th>     <th>std err</th>      <th>t</th>      <th>P>|t|</th>  <th>[0.025</th>    <th>0.975]</th>  
</tr>
<tr>
  <th>Intercept</th> <td> 6.482e+04</td> <td>  131.524</td> <td>  492.869</td> <td> 0.000</td> <td> 6.46e+04</td> <td> 6.51e+04</td>
</tr>
<tr>
  <th>months</th>    <td>   10.9886</td> <td>    1.044</td> <td>   10.530</td> <td> 0.000</td> <td>    8.931</td> <td>   13.046</td>
</tr>
</table></div><div class="output text_html"><table class="simpletable">
<tr>
  <td>R-squared:</td> <td>0.3477</td>
</tr>
</table></div><script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 29;
                var nbb_unformatted_code = "from thinkstats import display_summary\n\ndisplay_summary(results)";
                var nbb_formatted_code = "from thinkstats import display_summary\n\ndisplay_summary(results)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>The <span class="math notranslate nohighlight">\(R^2\)</span> value is about 0.35, which suggests that the model does not fit the data particularly well.
We can get a better sense of that by plotting the fitted line.
We’ll use the <code class="docutils literal notranslate"><span class="pre">predict</span></code> method to retrodict the values in the training data and predict the values in the test data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">months</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">training</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">test</span><span class="p">))</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;months&quot;</span><span class="p">:</span> <span class="n">months</span><span class="p">})</span>
<span class="n">pred_trend</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<span class="n">pred_trend</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">nuclear</span><span class="o">.</span><span class="n">index</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 30;
                var nbb_unformatted_code = "months = np.arange(len(training) + len(test))\ndf = pd.DataFrame({\"months\": months})\npred_trend = results.predict(df)\npred_trend.index = nuclear.index";
                var nbb_formatted_code = "months = np.arange(len(training) + len(test))\ndf = pd.DataFrame({\"months\": months})\npred_trend = results.predict(df)\npred_trend.index = nuclear.index";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>Here’s the trend component and the linear model.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">trend</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;C1&quot;</span><span class="p">)</span>
<span class="n">pred_trend</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;0.6&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;linear model&quot;</span><span class="p">)</span>
<span class="n">decorate</span><span class="p">(</span><span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;GWh&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/5be8b0d789cb9586e91afbc918fcc6f624f3f382adc3b6a494aed0dc0402b5b8.png" src="_images/5be8b0d789cb9586e91afbc918fcc6f624f3f382adc3b6a494aed0dc0402b5b8.png" />
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 31;
                var nbb_unformatted_code = "trend.plot(color=\"C1\")\npred_trend.plot(color=\"0.6\", label=\"linear model\")\ndecorate(ylabel=\"GWh\")";
                var nbb_formatted_code = "trend.plot(color=\"C1\")\npred_trend.plot(color=\"0.6\", label=\"linear model\")\ndecorate(ylabel=\"GWh\")";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>There’s a lot going on that’s not captured by the linear model, but it looks like there is a generally increasing trend.</p>
<p>To predict the seasonal component, we’ll use the seasonal component from the decomposition to compute a <code class="docutils literal notranslate"><span class="pre">Series</span></code> of monthly averages.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">seasonal</span> <span class="o">=</span> <span class="n">decomposition</span><span class="o">.</span><span class="n">seasonal</span>
<span class="n">monthly_averages</span> <span class="o">=</span> <span class="n">seasonal</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">seasonal</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 32;
                var nbb_unformatted_code = "seasonal = decomposition.seasonal\nmonthly_averages = seasonal.groupby(seasonal.index.month).mean()";
                var nbb_formatted_code = "seasonal = decomposition.seasonal\nmonthly_averages = seasonal.groupby(seasonal.index.month).mean()";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>Now we can compute the seasonal component by looking up the dates from the fitted line in <code class="docutils literal notranslate"><span class="pre">monthly_averages</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pred_seasonal</span> <span class="o">=</span> <span class="n">monthly_averages</span><span class="p">[</span><span class="n">pred_trend</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span><span class="p">]</span>
<span class="n">pred_seasonal</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pred_trend</span><span class="o">.</span><span class="n">index</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 33;
                var nbb_unformatted_code = "pred_seasonal = monthly_averages[pred_trend.index.month]\npred_seasonal.index = pred_trend.index";
                var nbb_formatted_code = "pred_seasonal = monthly_averages[pred_trend.index.month]\npred_seasonal.index = pred_trend.index";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>Finally, to generate predictions, we’ll add the seasonal component to the trend.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pred</span> <span class="o">=</span> <span class="n">pred_trend</span> <span class="o">+</span> <span class="n">pred_seasonal</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 34;
                var nbb_unformatted_code = "pred = pred_trend + pred_seasonal";
                var nbb_formatted_code = "pred = pred_trend + pred_seasonal";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>Here’s the training data and the predictions.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">training</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;training&quot;</span><span class="p">)</span>
<span class="n">pred</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;0.8&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;prediction&quot;</span><span class="p">)</span>
<span class="n">decorate</span><span class="p">(</span><span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;GWh&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/0173f2aab1acf5f216a320d8fb13cd40f611271087a5fcf9651ce3090250a773.png" src="_images/0173f2aab1acf5f216a320d8fb13cd40f611271087a5fcf9651ce3090250a773.png" />
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 35;
                var nbb_unformatted_code = "training.plot(label=\"training\")\npred.plot(color=\"0.8\", label=\"prediction\")\ndecorate(ylabel=\"GWh\")";
                var nbb_formatted_code = "training.plot(label=\"training\")\npred.plot(color=\"0.8\", label=\"prediction\")\ndecorate(ylabel=\"GWh\")";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>The predictions fit the training data reasonably well, and the forecast looks like a reasonable projection of the data, based on the assumption that the long-term trend will continue.</p>
<p>Now, from the vantage point of the future, let’s see how accurate this forecast turned out to be.
Here is are the predicted and actual values for the five-year interval from July 2019.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">forecast</span> <span class="o">=</span> <span class="n">pred</span><span class="p">[</span><span class="n">test</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
<span class="n">forecast</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ls</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;0.6&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;predicted&quot;</span><span class="p">)</span>
<span class="n">test</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;actual&quot;</span><span class="p">)</span>
<span class="n">decorate</span><span class="p">(</span><span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;GWh&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/06fdd4afa980d9147e47045b559f53a12fb68b7f82257f0347401d18a0d8d434.png" src="_images/06fdd4afa980d9147e47045b559f53a12fb68b7f82257f0347401d18a0d8d434.png" />
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 36;
                var nbb_unformatted_code = "forecast = pred[test.index]\nforecast.plot(ls=\"--\", color=\"0.6\", label=\"predicted\")\ntest.plot(label=\"actual\")\ndecorate(ylabel=\"GWh\")";
                var nbb_formatted_code = "forecast = pred[test.index]\nforecast.plot(ls=\"--\", color=\"0.6\", label=\"predicted\")\ntest.plot(label=\"actual\")\ndecorate(ylabel=\"GWh\")";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>The first year of the forecast was pretty good, but production from nuclear reactors in 2020 was lower than expected – probably due to the COVID-19 pandemic – and it never returned to the long-term trend.</p>
<p>To quantify the accuracy of the predictions, we’ll use the mean absolute percentage error (MAPE), which the following function computes.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">MAPE</span><span class="p">(</span><span class="n">predicted</span><span class="p">,</span> <span class="n">actual</span><span class="p">):</span>
    <span class="n">ape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">predicted</span> <span class="o">-</span> <span class="n">actual</span><span class="p">)</span> <span class="o">/</span> <span class="n">actual</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ape</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 37;
                var nbb_unformatted_code = "def MAPE(predicted, actual):\n    ape = np.abs(predicted - actual) / actual\n    return np.mean(ape) * 100";
                var nbb_formatted_code = "def MAPE(predicted, actual):\n    ape = np.abs(predicted - actual) / actual\n    return np.mean(ape) * 100";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>In this example, the predictions are off by 3.81% on average.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">MAPE</span><span class="p">(</span><span class="n">forecast</span><span class="p">,</span> <span class="n">test</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>3.811940747879257
</pre></div>
</div>
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 38;
                var nbb_unformatted_code = "MAPE(forecast, test)";
                var nbb_formatted_code = "MAPE(forecast, test)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>We’ll come back to this example later in the chapter and see if we can do better with a different model.</p>
</section>
<section id="multiplicative-model">
<h2><span class="section-number">12.4. </span>Multiplicative Model<a class="headerlink" href="#multiplicative-model" title="Link to this heading">#</a></h2>
<p>The additive model we used in the previous section is based on the assumption that the time series is well modeled as the <em>sum</em> of a long-term trend, a seasonal component, and a residual component – which implies that the magnitude of the seasonal component and the residuals does not vary over time.</p>
<p>As an example that violates this assumption, let’s look at small-scale solar electricity production since 2014.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">solar</span> <span class="o">=</span> <span class="n">elec</span><span class="p">[</span><span class="s2">&quot;United States : small-scale solar photovoltaic&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
<span class="n">solar</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;solar&quot;</span><span class="p">)</span>
<span class="n">decorate</span><span class="p">(</span><span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;GWh&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/86539269db9ce2568bf7bb6e80c25d37c5d8ddc93ba8de6352e857d8bb148cec.png" src="_images/86539269db9ce2568bf7bb6e80c25d37c5d8ddc93ba8de6352e857d8bb148cec.png" />
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 39;
                var nbb_unformatted_code = "solar = elec[\"United States : small-scale solar photovoltaic\"].dropna()\nsolar.plot(label=\"solar\")\ndecorate(ylabel=\"GWh\")";
                var nbb_formatted_code = "solar = elec[\"United States : small-scale solar photovoltaic\"].dropna()\nsolar.plot(label=\"solar\")\ndecorate(ylabel=\"GWh\")";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>Over this interval, total production has increased several times over.
And it’s clear that the magnitude of seasonal variation has increased as well.</p>
<p>If suppose that the magnitudes of seasonal and random variation are proportional to the magnitude of the trend, that suggests an alternative to the additive model in which the time series is the <em>product</em> of a trend, a seasonal component, and a residual component.</p>
<p>To try out this multiplicative model, we’ll split this series into training and test sets.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">training</span><span class="p">,</span> <span class="n">test</span> <span class="o">=</span> <span class="n">split_series</span><span class="p">(</span><span class="n">solar</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 40;
                var nbb_unformatted_code = "training, test = split_series(solar)";
                var nbb_formatted_code = "training, test = split_series(solar)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>And call <code class="docutils literal notranslate"><span class="pre">seasonal_decompose</span></code> with the <code class="docutils literal notranslate"><span class="pre">model=multiplicative</span></code> argument.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">decomposition</span> <span class="o">=</span> <span class="n">seasonal_decompose</span><span class="p">(</span><span class="n">training</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="s2">&quot;multiplicative&quot;</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 41;
                var nbb_unformatted_code = "decomposition = seasonal_decompose(training, model=\"multiplicative\", period=12)";
                var nbb_formatted_code = "decomposition = seasonal_decompose(training, model=\"multiplicative\", period=12)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>Here’s what the results look like.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_decomposition</span><span class="p">(</span><span class="n">training</span><span class="p">,</span> <span class="n">decomposition</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/eff587bb6527bbf770da7f8e33ab451633af92b85cc8dd6c2c1d44ccaacd37ed.png" src="_images/eff587bb6527bbf770da7f8e33ab451633af92b85cc8dd6c2c1d44ccaacd37ed.png" />
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 42;
                var nbb_unformatted_code = "plot_decomposition(training, decomposition)";
                var nbb_formatted_code = "plot_decomposition(training, decomposition)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>Now the seasonal and residual components are multiplicative factors.
So, it looks like the seasonal component varies from about 25% below the trend to 25% above.
And the residual component is usually less than 5% either way, with the exception of some larger factors in the first period.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">trend</span> <span class="o">=</span> <span class="n">decomposition</span><span class="o">.</span><span class="n">trend</span>
<span class="n">seasonal</span> <span class="o">=</span> <span class="n">decomposition</span><span class="o">.</span><span class="n">seasonal</span>
<span class="n">resid</span> <span class="o">=</span> <span class="n">decomposition</span><span class="o">.</span><span class="n">resid</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 43;
                var nbb_unformatted_code = "trend = decomposition.trend\nseasonal = decomposition.seasonal\nresid = decomposition.resid";
                var nbb_formatted_code = "trend = decomposition.trend\nseasonal = decomposition.seasonal\nresid = decomposition.resid";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>The <span class="math notranslate nohighlight">\(R^2\)</span> value of this model is very high.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rsquared</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">resid</span><span class="o">.</span><span class="n">var</span><span class="p">()</span> <span class="o">/</span> <span class="n">training</span><span class="o">.</span><span class="n">var</span><span class="p">()</span>
<span class="n">rsquared</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.9999999992978134
</pre></div>
</div>
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 44;
                var nbb_unformatted_code = "rsquared = 1 - resid.var() / training.var()\nrsquared";
                var nbb_formatted_code = "rsquared = 1 - resid.var() / training.var()\nrsquared";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>The production of a solar panel is almost entirely a function of the sunlight it’s exposed to, so it makes sense that it follows an annual cycle so closely.</p>
<p>To predict the long term trend, we’ll use a quadratic model.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">months</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">training</span><span class="p">))</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;trend&quot;</span><span class="p">:</span> <span class="n">trend</span><span class="p">,</span> <span class="s2">&quot;months&quot;</span><span class="p">:</span> <span class="n">months</span><span class="p">})</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span><span class="s2">&quot;trend ~ months + I(months**2)&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 45;
                var nbb_unformatted_code = "months = range(len(training))\ndata = pd.DataFrame({\"trend\": trend, \"months\": months}).dropna()\nresults = smf.ols(\"trend ~ months + I(months**2)\", data=data).fit()";
                var nbb_formatted_code = "months = range(len(training))\ndata = pd.DataFrame({\"trend\": trend, \"months\": months}).dropna()\nresults = smf.ols(\"trend ~ months + I(months**2)\", data=data).fit()";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>In the Patsy formula, the term <code class="docutils literal notranslate"><span class="pre">&quot;I(months**2)&quot;</span></code> adds a quadratic term to the model, so we don’t have to compute it explicitly.
Here are the results.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">display_summary</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table class="simpletable">
<tr>
         <td></td>           <th>coef</th>     <th>std err</th>      <th>t</th>      <th>P>|t|</th>  <th>[0.025</th>    <th>0.975]</th>  
</tr>
<tr>
  <th>Intercept</th>      <td>  766.1962</td> <td>   13.494</td> <td>   56.782</td> <td> 0.000</td> <td>  739.106</td> <td>  793.286</td>
</tr>
<tr>
  <th>months</th>         <td>   22.2153</td> <td>    0.938</td> <td>   23.673</td> <td> 0.000</td> <td>   20.331</td> <td>   24.099</td>
</tr>
<tr>
  <th>I(months ** 2)</th> <td>    0.1762</td> <td>    0.014</td> <td>   12.480</td> <td> 0.000</td> <td>    0.148</td> <td>    0.205</td>
</tr>
</table></div><div class="output text_html"><table class="simpletable">
<tr>
  <td>R-squared:</td> <td>0.9983</td>
</tr>
</table></div><script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 46;
                var nbb_unformatted_code = "display_summary(results)";
                var nbb_formatted_code = "display_summary(results)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>The p-values of the linear and quadratic terms are very low, which suggests that the quadratic model captures more information about the trend than a linear model would – and the <span class="math notranslate nohighlight">\(R^2\)</span> value is very high.</p>
<p>Now we can use the model to compute the expected value of the trend for the past and future.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">months</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">solar</span><span class="p">))</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;months&quot;</span><span class="p">:</span> <span class="n">months</span><span class="p">})</span>
<span class="n">pred_trend</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<span class="n">pred_trend</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">solar</span><span class="o">.</span><span class="n">index</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 47;
                var nbb_unformatted_code = "months = range(len(solar))\ndf = pd.DataFrame({\"months\": months})\npred_trend = results.predict(df)\npred_trend.index = solar.index";
                var nbb_formatted_code = "months = range(len(solar))\ndf = pd.DataFrame({\"months\": months})\npred_trend = results.predict(df)\npred_trend.index = solar.index";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>Here’s what it looks like.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pred_trend</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;0.8&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;quadratic model&quot;</span><span class="p">)</span>
<span class="n">trend</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;C1&quot;</span><span class="p">)</span>
<span class="n">decorate</span><span class="p">(</span><span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;GWh&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/a5a5c42d8344c1c9773f46a0e41736b2243856990ad79cc4ee351ece33e24300.png" src="_images/a5a5c42d8344c1c9773f46a0e41736b2243856990ad79cc4ee351ece33e24300.png" />
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 48;
                var nbb_unformatted_code = "pred_trend.plot(color=\"0.8\", label=\"quadratic model\")\ntrend.plot(color=\"C1\")\ndecorate(ylabel=\"GWh\")";
                var nbb_formatted_code = "pred_trend.plot(color=\"0.8\", label=\"quadratic model\")\ntrend.plot(color=\"C1\")\ndecorate(ylabel=\"GWh\")";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>The quadratic model fits the past trend well.
Now we can use the seasonal component from the decomposition to predict the seasonal component.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">monthly_averages</span> <span class="o">=</span> <span class="n">seasonal</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">seasonal</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">pred_seasonal</span> <span class="o">=</span> <span class="n">monthly_averages</span><span class="p">[</span><span class="n">pred_trend</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span><span class="p">]</span>
<span class="n">pred_seasonal</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pred_trend</span><span class="o">.</span><span class="n">index</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 49;
                var nbb_unformatted_code = "monthly_averages = seasonal.groupby(seasonal.index.month).mean()\npred_seasonal = monthly_averages[pred_trend.index.month]\npred_seasonal.index = pred_trend.index";
                var nbb_formatted_code = "monthly_averages = seasonal.groupby(seasonal.index.month).mean()\npred_seasonal = monthly_averages[pred_trend.index.month]\npred_seasonal.index = pred_trend.index";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>Finally, to compute “retrodictions” for past values and predictions for the future, we multiply the trend and the seasonal component.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pred</span> <span class="o">=</span> <span class="n">pred_trend</span> <span class="o">*</span> <span class="n">pred_seasonal</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 50;
                var nbb_unformatted_code = "pred = pred_trend * pred_seasonal";
                var nbb_formatted_code = "pred = pred_trend * pred_seasonal";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>Here is the result along with the training data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">training</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;training&quot;</span><span class="p">)</span>
<span class="n">pred</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;0.6&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;prediction&quot;</span><span class="p">)</span>
<span class="n">decorate</span><span class="p">(</span><span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;GWh&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/388e99505acc1f95283d9016e2a7d4839822a519bc821b9b6ec1a56f41aa3cdf.png" src="_images/388e99505acc1f95283d9016e2a7d4839822a519bc821b9b6ec1a56f41aa3cdf.png" />
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 51;
                var nbb_unformatted_code = "training.plot(label=\"training\")\npred.plot(alpha=0.6, color=\"0.6\", label=\"prediction\")\ndecorate(ylabel=\"GWh\")";
                var nbb_formatted_code = "training.plot(label=\"training\")\npred.plot(alpha=0.6, color=\"0.6\", label=\"prediction\")\ndecorate(ylabel=\"GWh\")";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>The retrodictions fit the training data well and the predictions seem plausible – now let’s see if they turned out to be accurate.
Here are the predictions along with the test data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">future</span> <span class="o">=</span> <span class="n">pred</span><span class="p">[</span><span class="n">test</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
<span class="n">future</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ls</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;0.6&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;prediction&quot;</span><span class="p">)</span>

<span class="n">test</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;actual&quot;</span><span class="p">)</span>
<span class="n">decorate</span><span class="p">(</span><span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;GWh&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/662c539d178eeda1c2b6a51234899f683bbe5fe20d981e1897d20811f7d0efd0.png" src="_images/662c539d178eeda1c2b6a51234899f683bbe5fe20d981e1897d20811f7d0efd0.png" />
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 52;
                var nbb_unformatted_code = "future = pred[test.index]\nfuture.plot(ls=\"--\", color=\"0.6\", label=\"prediction\")\n\ntest.plot(label=\"actual\")\ndecorate(ylabel=\"GWh\")";
                var nbb_formatted_code = "future = pred[test.index]\nfuture.plot(ls=\"--\", color=\"0.6\", label=\"prediction\")\n\ntest.plot(label=\"actual\")\ndecorate(ylabel=\"GWh\")";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>For the first three years, the predictions are very good.
After that, it looks like actual growth exceeded expectations.</p>
<p>In this example, seasonal decomposition worked well for modeling and predicting solar production, but in the previous example, it was not very effective for nuclear production.
In the next section, we’ll try a different approach, autoregression.</p>
</section>
<section id="autoregression">
<h2><span class="section-number">12.5. </span>Autoregression<a class="headerlink" href="#autoregression" title="Link to this heading">#</a></h2>
<p>The first idea of autoregression is that the future will be like the past.
For example, in the time series we’ve looked at so far, there is a clear annual cycle.
So if you are asked to make a prediction for next June, a good starting place would be last June.</p>
<p>To see how well that might work, let’s go back to <code class="docutils literal notranslate"><span class="pre">nuclear</span></code>, which contains monthly electricity production from nuclear generators, and compute differences between the same month in successive years, which are called “year-over-year” differences.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">diff</span> <span class="o">=</span> <span class="p">(</span><span class="n">nuclear</span> <span class="o">-</span> <span class="n">nuclear</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">12</span><span class="p">))</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
<span class="n">diff</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;year over year differences&quot;</span><span class="p">)</span>
<span class="n">decorate</span><span class="p">(</span><span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;GWh&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/f7d73b203c70e39e305fb247ee2d022c6790d49d1b31a462830f328136d5e46b.png" src="_images/f7d73b203c70e39e305fb247ee2d022c6790d49d1b31a462830f328136d5e46b.png" />
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 53;
                var nbb_unformatted_code = "diff = (nuclear - nuclear.shift(12)).dropna()\ndiff.plot(label=\"year over year differences\")\ndecorate(ylabel=\"GWh\")";
                var nbb_formatted_code = "diff = (nuclear - nuclear.shift(12)).dropna()\ndiff.plot(label=\"year over year differences\")\ndecorate(ylabel=\"GWh\")";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>The magnitudes of these differences are substantially smaller than the magnitudes of the original series, which suggests the second idea of autoregression, which is that it might be easier to predict these differences, rather than the original values.</p>
<p>Toward that end, let’s see if there are correlations between successive elements in the series of differences.
If so, we could use those correlations to predict future values based on previous values.</p>
<p>I’ll start by making a <code class="docutils literal notranslate"><span class="pre">DataFrame</span></code> with the differences in the first column and the same differences – shifted by 1, 2, and 3 months.
These columns are named <code class="docutils literal notranslate"><span class="pre">lag1</span></code>, <code class="docutils literal notranslate"><span class="pre">lag2</span></code>, and <code class="docutils literal notranslate"><span class="pre">lag3</span></code>, because the series they contain have been “lagged” or delayed.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_ar</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;diff&quot;</span><span class="p">:</span> <span class="n">diff</span><span class="p">})</span>
<span class="k">for</span> <span class="n">lag</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]:</span>
    <span class="n">df_ar</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;lag</span><span class="si">{</span><span class="n">lag</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">diff</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">lag</span><span class="p">)</span>

<span class="n">df_ar</span> <span class="o">=</span> <span class="n">df_ar</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 54;
                var nbb_unformatted_code = "df_ar = pd.DataFrame({\"diff\": diff})\nfor lag in [1, 2, 3]:\n    df_ar[f\"lag{lag}\"] = diff.shift(lag)\n\ndf_ar = df_ar.dropna()";
                var nbb_formatted_code = "df_ar = pd.DataFrame({\"diff\": diff})\nfor lag in [1, 2, 3]:\n    df_ar[f\"lag{lag}\"] = diff.shift(lag)\n\ndf_ar = df_ar.dropna()";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>Here are the correlations between these columns.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_ar</span><span class="o">.</span><span class="n">corr</span><span class="p">()[[</span><span class="s2">&quot;diff&quot;</span><span class="p">]]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>diff</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>diff</th>
      <td>1.000000</td>
    </tr>
    <tr>
      <th>lag1</th>
      <td>0.562212</td>
    </tr>
    <tr>
      <th>lag2</th>
      <td>0.292454</td>
    </tr>
    <tr>
      <th>lag3</th>
      <td>0.222228</td>
    </tr>
  </tbody>
</table>
</div></div><script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 55;
                var nbb_unformatted_code = "df_ar.corr()[[\"diff\"]]";
                var nbb_formatted_code = "df_ar.corr()[[\"diff\"]]";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>The correlation between <code class="docutils literal notranslate"><span class="pre">diff</span></code> and <code class="docutils literal notranslate"><span class="pre">lag1</span></code> is called <strong>serial correlation</strong> because it is the correlation between successive elements in the series.
The other correlations are called lagged correlations or <strong>autocorrelations</strong> – the prefix “auto” indicates that we’re taking the correlation of the series with itself.</p>
<p>These correlation are strong enough to suggest that they should help with prediction, so let’s put them into a multiple regression.
The following function uses the columns from the <code class="docutils literal notranslate"><span class="pre">DataFrame</span></code> to make a Patsy formula with the first column as the dependent variable and the other columns as explanatory variable.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">make_formula</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Make a Patsy formula from column names.&quot;&quot;&quot;</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">xs</span> <span class="o">=</span> <span class="s2">&quot; + &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">y</span><span class="si">}</span><span class="s2"> ~ </span><span class="si">{</span><span class="n">xs</span><span class="si">}</span><span class="s2">&quot;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 56;
                var nbb_unformatted_code = "def make_formula(df):\n    \"\"\"Make a Patsy formula from column names.\"\"\"\n    y = df.columns[0]\n    xs = \" + \".join(df.columns[1:])\n    return f\"{y} ~ {xs}\"";
                var nbb_formatted_code = "def make_formula(df):\n    \"\"\"Make a Patsy formula from column names.\"\"\"\n    y = df.columns[0]\n    xs = \" + \".join(df.columns[1:])\n    return f\"{y} ~ {xs}\"";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>Here are the results of a linear model that predicts the next value in a sequence based on the previous three values.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">formula</span> <span class="o">=</span> <span class="n">make_formula</span><span class="p">(</span><span class="n">df_ar</span><span class="p">)</span>
<span class="n">results_ar</span> <span class="o">=</span> <span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span><span class="n">formula</span><span class="o">=</span><span class="n">formula</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df_ar</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="n">display_summary</span><span class="p">(</span><span class="n">results_ar</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table class="simpletable">
<tr>
      <td></td>         <th>coef</th>     <th>std err</th>      <th>t</th>      <th>P>|t|</th>  <th>[0.025</th>    <th>0.975]</th>  
</tr>
<tr>
  <th>Intercept</th> <td>   24.2674</td> <td>  114.674</td> <td>    0.212</td> <td> 0.833</td> <td> -201.528</td> <td>  250.063</td>
</tr>
<tr>
  <th>lag1</th>      <td>    0.5847</td> <td>    0.061</td> <td>    9.528</td> <td> 0.000</td> <td>    0.464</td> <td>    0.706</td>
</tr>
<tr>
  <th>lag2</th>      <td>   -0.0908</td> <td>    0.071</td> <td>   -1.277</td> <td> 0.203</td> <td>   -0.231</td> <td>    0.049</td>
</tr>
<tr>
  <th>lag3</th>      <td>    0.1026</td> <td>    0.062</td> <td>    1.666</td> <td> 0.097</td> <td>   -0.019</td> <td>    0.224</td>
</tr>
</table></div><div class="output text_html"><table class="simpletable">
<tr>
  <td>R-squared:</td> <td>0.3239</td>
</tr>
</table></div><script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 57;
                var nbb_unformatted_code = "formula = make_formula(df_ar)\nresults_ar = smf.ols(formula=formula, data=df_ar).fit()\ndisplay_summary(results_ar)";
                var nbb_formatted_code = "formula = make_formula(df_ar)\nresults_ar = smf.ols(formula=formula, data=df_ar).fit()\ndisplay_summary(results_ar)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>The p-values</p>
<p>Here’s what these retrodictions look like compared to the data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pred_ar</span> <span class="o">=</span> <span class="n">results_ar</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">df_ar</span><span class="p">)</span>
<span class="n">diff</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;differences&quot;</span><span class="p">)</span>
<span class="n">pred_ar</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;0.8&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;predictions&quot;</span><span class="p">)</span>
<span class="n">decorate</span><span class="p">(</span><span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;GWh&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/f4c105ff36663ba3e0370ba8135c0b595ed2006e26bbc5195e2cf6f3a1620beb.png" src="_images/f4c105ff36663ba3e0370ba8135c0b595ed2006e26bbc5195e2cf6f3a1620beb.png" />
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 58;
                var nbb_unformatted_code = "pred_ar = results_ar.predict(df_ar)\ndiff.plot(label=\"differences\")\npred_ar.plot(color=\"0.8\", label=\"predictions\")\ndecorate(ylabel=\"GWh\")";
                var nbb_formatted_code = "pred_ar = results_ar.predict(df_ar)\ndiff.plot(label=\"differences\")\npred_ar.plot(color=\"0.8\", label=\"predictions\")\ndecorate(ylabel=\"GWh\")";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>The predictions are good in some places, but the <span class="math notranslate nohighlight">\(R^2\)</span> value is only about 0.319, so there is room for improvement.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">resid_ar</span> <span class="o">=</span> <span class="p">(</span><span class="n">diff</span> <span class="o">-</span> <span class="n">pred_ar</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
<span class="n">R2</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">resid_ar</span><span class="o">.</span><span class="n">var</span><span class="p">()</span> <span class="o">/</span> <span class="n">diff</span><span class="o">.</span><span class="n">var</span><span class="p">()</span>
<span class="n">R2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.3190252265690783
</pre></div>
</div>
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 59;
                var nbb_unformatted_code = "resid_ar = (diff - pred_ar).dropna()\nR2 = 1 - resid_ar.var() / diff.var()\nR2";
                var nbb_formatted_code = "resid_ar = (diff - pred_ar).dropna()\nR2 = 1 - resid_ar.var() / diff.var()\nR2";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>One way to improve the predictions is to compute the residuals from this model, and use another model to predict the residuals, which is the third idea of autoregression.</p>
</section>
<section id="moving-average">
<h2><span class="section-number">12.6. </span>Moving Average<a class="headerlink" href="#moving-average" title="Link to this heading">#</a></h2>
<p>Suppose it’s June 2019, and you are asked to make a prediction for June 2020.
You first guess might be that this year’s value will be repeated next year.</p>
<p>Now suppose it’s May 2020, and you are asked to revise your prediction for June 2020.
You could use the results from the last three months, and the autocorrelation model from the previous section, to predict the year-over-year difference.</p>
<p>Finally, suppose you check the predictions for the last few months, and see that they have been consistently too low.
That suggests that the prediction for next month might also be too low, so you could revise it upward.
The underlying assumption is that recent prediction errors predict future prediction errors.</p>
<p>To see whether they do, we can make a <code class="docutils literal notranslate"><span class="pre">DataFrame</span></code> with the residuals from the autoregression model in the first column, and lagged versions of the residuals in the other columns.
For this example, I’ll use lags of 1 and 6 months.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_ma</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;resid&quot;</span><span class="p">:</span> <span class="n">resid_ar</span><span class="p">})</span>

<span class="k">for</span> <span class="n">lag</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">]:</span>
    <span class="n">df_ma</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;lag</span><span class="si">{</span><span class="n">lag</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">resid_ar</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">lag</span><span class="p">)</span>

<span class="n">df_ma</span> <span class="o">=</span> <span class="n">df_ma</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 60;
                var nbb_unformatted_code = "df_ma = pd.DataFrame({\"resid\": resid_ar})\n\nfor lag in [1, 6]:\n    df_ma[f\"lag{lag}\"] = resid_ar.shift(lag)\n\ndf_ma = df_ma.dropna()";
                var nbb_formatted_code = "df_ma = pd.DataFrame({\"resid\": resid_ar})\n\nfor lag in [1, 6]:\n    df_ma[f\"lag{lag}\"] = resid_ar.shift(lag)\n\ndf_ma = df_ma.dropna()";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>We can use <code class="docutils literal notranslate"><span class="pre">ols</span></code> to make an autoregression model for the residuals.
This part of the model is called a <strong>moving average</strong> because it reduces variability in the predictions in a way that’s analogous to the effect of a moving average.
I don’t find that term particularly helpful, but it is conventional.</p>
<p>Anyway, here’s a summary of the autoregression model for the residuals.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">formula</span> <span class="o">=</span> <span class="n">make_formula</span><span class="p">(</span><span class="n">df_ma</span><span class="p">)</span>
<span class="n">results_ma</span> <span class="o">=</span> <span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span><span class="n">formula</span><span class="o">=</span><span class="n">formula</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df_ma</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="n">display_summary</span><span class="p">(</span><span class="n">results_ma</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table class="simpletable">
<tr>
      <td></td>         <th>coef</th>     <th>std err</th>      <th>t</th>      <th>P>|t|</th>  <th>[0.025</th>    <th>0.975]</th>  
</tr>
<tr>
  <th>Intercept</th> <td>  -14.0016</td> <td>  114.697</td> <td>   -0.122</td> <td> 0.903</td> <td> -239.863</td> <td>  211.860</td>
</tr>
<tr>
  <th>lag1</th>      <td>    0.0014</td> <td>    0.062</td> <td>    0.023</td> <td> 0.982</td> <td>   -0.120</td> <td>    0.123</td>
</tr>
<tr>
  <th>lag6</th>      <td>   -0.1592</td> <td>    0.063</td> <td>   -2.547</td> <td> 0.011</td> <td>   -0.282</td> <td>   -0.036</td>
</tr>
</table></div><div class="output text_html"><table class="simpletable">
<tr>
  <td>R-squared:</td> <td>0.0247</td>
</tr>
</table></div><script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 61;
                var nbb_unformatted_code = "formula = make_formula(df_ma)\nresults_ma = smf.ols(formula=formula, data=df_ma).fit()\ndisplay_summary(results_ma)";
                var nbb_formatted_code = "formula = make_formula(df_ma)\nresults_ma = smf.ols(formula=formula, data=df_ma).fit()\ndisplay_summary(results_ma)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>The <span class="math notranslate nohighlight">\(R^2\)</span> is quite small, so it looks like this part of the model won’t help very much.
But the p-value for the 6-month lag is small, which suggests that it contributes more information than we’d expect by chance.</p>
<p>Again, we can use the model to generate retrodictions for the residuals.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pred_ma</span> <span class="o">=</span> <span class="n">results_ma</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">df_ma</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 62;
                var nbb_unformatted_code = "pred_ma = results_ma.predict(df_ma)";
                var nbb_formatted_code = "pred_ma = results_ma.predict(df_ma)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>Then, to generate retrodictions for the year-over-year differences, we add the adjustment from the second model to the retrodictions from the first.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pred_diff</span> <span class="o">=</span> <span class="n">pred_ar</span> <span class="o">+</span> <span class="n">pred_ma</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 63;
                var nbb_unformatted_code = "pred_diff = pred_ar + pred_ma";
                var nbb_formatted_code = "pred_diff = pred_ar + pred_ma";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>The <span class="math notranslate nohighlight">\(R^2\)</span> value for the sum of the two models is about 0.332, which is a little better than the result without the moving average adjustment (0.319).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">resid</span> <span class="o">=</span> <span class="p">(</span><span class="n">diff</span> <span class="o">-</span> <span class="n">pred_diff</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
<span class="n">R2</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">resid</span><span class="o">.</span><span class="n">var</span><span class="p">()</span> <span class="o">/</span> <span class="n">diff</span><span class="o">.</span><span class="n">var</span><span class="p">()</span>
<span class="n">R2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.3315101001391231
</pre></div>
</div>
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 64;
                var nbb_unformatted_code = "resid = (diff - pred_diff).dropna()\nR2 = 1 - resid.var() / diff.var()\nR2";
                var nbb_formatted_code = "resid = (diff - pred_diff).dropna()\nR2 = 1 - resid.var() / diff.var()\nR2";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>Next we’ll use these year-over-year differences to generate retrodictions for the original values.</p>
</section>
<section id="retrodiction-with-autoregression">
<h2><span class="section-number">12.7. </span>Retrodiction with Autoregression<a class="headerlink" href="#retrodiction-with-autoregression" title="Link to this heading">#</a></h2>
<p>To generate retrodictions, we’ll start by putting the year-over-year differences in a <code class="docutils literal notranslate"><span class="pre">Series</span></code> that’s aligned with the index of the original.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pred_diff</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">pred_diff</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">nuclear</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 65;
                var nbb_unformatted_code = "pred_diff = pd.Series(pred_diff, index=nuclear.index)";
                var nbb_formatted_code = "pred_diff = pd.Series(pred_diff, index=nuclear.index)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>Using <code class="docutils literal notranslate"><span class="pre">isna</span></code> to check for <code class="docutils literal notranslate"><span class="pre">NaN</span></code> values, we find that the first 21 elements of the new <code class="docutils literal notranslate"><span class="pre">Series</span></code> are missing.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n_missing</span> <span class="o">=</span> <span class="n">pred_diff</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 66;
                var nbb_unformatted_code = "n_missing = pred_diff.isna().sum()";
                var nbb_formatted_code = "n_missing = pred_diff.isna().sum()";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>That’s because we shifted the <code class="docutils literal notranslate"><span class="pre">Series</span></code> by 12 months to compute year-over-year differences, then we shifted the differences 3 months for the first autoregression model, and we shifted the residuals of the first model by 6 months for the second model.
Each time we shift a series like this, we lose a few values at the beginning of the <code class="docutils literal notranslate"><span class="pre">Series</span></code>, and the sum of these shifts is 21.</p>
<p>So before we can generate retrodictions, we have to prime the pump by copying the first 21 elements from the original into a new <code class="docutils literal notranslate"><span class="pre">Series</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pred_series</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">nuclear</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<span class="n">pred_series</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="n">n_missing</span><span class="p">]</span> <span class="o">=</span> <span class="n">nuclear</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="n">n_missing</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 67;
                var nbb_unformatted_code = "pred_series = pd.Series(index=nuclear.index, dtype=float)\npred_series.iloc[:n_missing] = nuclear.iloc[:n_missing]";
                var nbb_formatted_code = "pred_series = pd.Series(index=nuclear.index, dtype=float)\npred_series.iloc[:n_missing] = nuclear.iloc[:n_missing]";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>Now we can run the following loop, which fills in the elements from number 21 (which is the 22nd) to the end.
Each element is the sum of the value from the previous year and the predicted year-over-year difference.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_missing</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">pred_series</span><span class="p">)):</span>
    <span class="n">pred_series</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pred_series</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">12</span><span class="p">]</span> <span class="o">+</span> <span class="n">pred_diff</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 68;
                var nbb_unformatted_code = "for i in range(n_missing, len(pred_series)):\n    pred_series.iloc[i] = pred_series.iloc[i - 12] + pred_diff.iloc[i]";
                var nbb_formatted_code = "for i in range(n_missing, len(pred_series)):\n    pred_series.iloc[i] = pred_series.iloc[i - 12] + pred_diff.iloc[i]";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>Now we’ll replace the elements we copied with <code class="docutils literal notranslate"><span class="pre">NaN</span></code> so we don’t get credit for “predicting” the first 21 values perfectly.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pred_series</span><span class="p">[:</span><span class="n">n_missing</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 69;
                var nbb_unformatted_code = "pred_series[:n_missing] = np.nan";
                var nbb_formatted_code = "pred_series[:n_missing] = np.nan";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>Here’s what the retrodictions look like compared to the original.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nuclear</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;actual&quot;</span><span class="p">)</span>
<span class="n">pred_series</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;0.9&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;predicted&quot;</span><span class="p">)</span>
<span class="n">decorate</span><span class="p">(</span><span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;GWh&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/40d4a59a6cdef6eba5d751b4e715a46928cc84d045b3a4f2a5c05e76047729db.png" src="_images/40d4a59a6cdef6eba5d751b4e715a46928cc84d045b3a4f2a5c05e76047729db.png" />
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 70;
                var nbb_unformatted_code = "nuclear.plot(label=\"actual\")\npred_series.plot(color=\"0.9\", label=\"predicted\")\ndecorate(ylabel=\"GWh\")";
                var nbb_formatted_code = "nuclear.plot(label=\"actual\")\npred_series.plot(color=\"0.9\", label=\"predicted\")\ndecorate(ylabel=\"GWh\")";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>They look pretty good, and the <span class="math notranslate nohighlight">\(R^2\)</span> value is about 0.86.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">resid</span> <span class="o">=</span> <span class="p">(</span><span class="n">nuclear</span> <span class="o">-</span> <span class="n">pred_series</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
<span class="n">R2</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">resid</span><span class="o">.</span><span class="n">var</span><span class="p">()</span> <span class="o">/</span> <span class="n">nuclear</span><span class="o">.</span><span class="n">var</span><span class="p">()</span>
<span class="n">R2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.8586566911201015
</pre></div>
</div>
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 71;
                var nbb_unformatted_code = "resid = (nuclear - pred_series).dropna()\nR2 = 1 - resid.var() / nuclear.var()\nR2";
                var nbb_formatted_code = "resid = (nuclear - pred_series).dropna()\nR2 = 1 - resid.var() / nuclear.var()\nR2";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>The model we used to compute these retrodictions is called SARIMA, which is one of a family of models called ARIMA.
Each part of these acronyms refers to an element of the model.</p>
<ul class="simple">
<li><p><strong>S</strong> stands for seasonal, because the first step was to compute differences between values separated by one seasonal period.</p></li>
<li><p><strong>AR</strong> stands for autoregression, which we used to model lagged correlations in the differences.</p></li>
<li><p><strong>I</strong> stands for integrated, because the iterative process we used to compute <code class="docutils literal notranslate"><span class="pre">pred_series</span></code> is analogous to integration in calculus.</p></li>
<li><p><strong>MA</strong> stands for moving average, which is the conventional name for the second autoregression model we ran with the residuals from the first.</p></li>
</ul>
<p>ARIMA models are powerful and versatile tools for modeling time series data.</p>
</section>
<section id="arima">
<h2><span class="section-number">12.8. </span>ARIMA<a class="headerlink" href="#arima" title="Link to this heading">#</a></h2>
<p>StatsModel provides a library called <code class="docutils literal notranslate"><span class="pre">tsa</span></code>, which stands for “time series analysis” – it includes a function called <code class="docutils literal notranslate"><span class="pre">ARIMA</span></code> that fits ARIMA models and generates forecasts.</p>
<p>To fit the SARIMA model we developed in the previous sections, we’ll call this function with two tuples as arguments: <code class="docutils literal notranslate"><span class="pre">order</span></code> and <code class="docutils literal notranslate"><span class="pre">seasonal_order</span></code>.
Here are the values in <code class="docutils literal notranslate"><span class="pre">order</span></code> that correspond to the model we used in the previous sections.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">order</span> <span class="o">=</span> <span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 72;
                var nbb_unformatted_code = "order = ([1, 2, 3], 0, [1, 6])";
                var nbb_formatted_code = "order = ([1, 2, 3], 0, [1, 6])";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>The values in <code class="docutils literal notranslate"><span class="pre">order</span></code> indicate:</p>
<ul class="simple">
<li><p>Which lags should be included in the AR model – in this example it’s the first three.</p></li>
<li><p>How many times it should compute differences between successive elements – in this example it’s 0 because we computed a seasonal difference instead, and we’ll get to that in a minute.</p></li>
<li><p>Which lags should be included in the MA model – in this example it’s the first and sixth.</p></li>
</ul>
<p>Now here are the values in <code class="docutils literal notranslate"><span class="pre">seasonal_order</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">seasonal_order</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 73;
                var nbb_unformatted_code = "seasonal_order = (0, 1, 0, 12)";
                var nbb_formatted_code = "seasonal_order = (0, 1, 0, 12)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>The first and third elements are 0, which means that this model does not include seasonal AR or seasonal MA.
The second element is 1, which means it computes seasonal differences – and the last element is the seasonal period.</p>
<p>Here’s how we use <code class="docutils literal notranslate"><span class="pre">ARIMA</span></code> to make and fit this model.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">statsmodels.tsa.api</span> <span class="k">as</span> <span class="nn">tsa</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">tsa</span><span class="o">.</span><span class="n">ARIMA</span><span class="p">(</span><span class="n">nuclear</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">]),</span> <span class="n">seasonal_order</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>
<span class="n">results_arima</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="n">display_summary</span><span class="p">(</span><span class="n">results_arima</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table class="simpletable">
<tr>
     <td></td>       <th>coef</th>     <th>std err</th>      <th>z</th>      <th>P>|z|</th>  <th>[0.025</th>    <th>0.975]</th>  
</tr>
<tr>
  <th>ar.L1</th>  <td>    0.0458</td> <td>    0.379</td> <td>    0.121</td> <td> 0.904</td> <td>   -0.697</td> <td>    0.788</td>
</tr>
<tr>
  <th>ar.L2</th>  <td>   -0.0035</td> <td>    0.116</td> <td>   -0.030</td> <td> 0.976</td> <td>   -0.230</td> <td>    0.223</td>
</tr>
<tr>
  <th>ar.L3</th>  <td>    0.0375</td> <td>    0.049</td> <td>    0.769</td> <td> 0.442</td> <td>   -0.058</td> <td>    0.133</td>
</tr>
<tr>
  <th>ma.L1</th>  <td>    0.2154</td> <td>    0.382</td> <td>    0.564</td> <td> 0.573</td> <td>   -0.533</td> <td>    0.964</td>
</tr>
<tr>
  <th>ma.L6</th>  <td>   -0.0672</td> <td>    0.019</td> <td>   -3.500</td> <td> 0.000</td> <td>   -0.105</td> <td>   -0.030</td>
</tr>
<tr>
  <th>sigma2</th> <td> 3.473e+06</td> <td>  1.9e-07</td> <td> 1.83e+13</td> <td> 0.000</td> <td> 3.47e+06</td> <td> 3.47e+06</td>
</tr>
</table></div><script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 74;
                var nbb_unformatted_code = "import statsmodels.tsa.api as tsa\n\nmodel = tsa.ARIMA(nuclear, order=(3, 0, [1, 6]), seasonal_order=(0, 1, 0, 12))\nresults_arima = model.fit()\ndisplay_summary(results_arima)";
                var nbb_formatted_code = "import statsmodels.tsa.api as tsa\n\nmodel = tsa.ARIMA(nuclear, order=(3, 0, [1, 6]), seasonal_order=(0, 1, 0, 12))\nresults_arima = model.fit()\ndisplay_summary(results_arima)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>The results include estimated coefficients for the three lags in the AR model, the two lags in the MA model, and <code class="docutils literal notranslate"><span class="pre">sigma2</span></code>, which is the variance of the residuals.</p>
<p>From <code class="docutils literal notranslate"><span class="pre">results_arima</span></code> we can extract <code class="docutils literal notranslate"><span class="pre">fittedvalues</span></code>, which contains the retrodictions.
For the same reason there were missing values at the beginning of the retrodictions we computed, there are incorrect values at the beginning of <code class="docutils literal notranslate"><span class="pre">fittedvalues</span></code>, which we’ll drop.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fittedvalues</span> <span class="o">=</span> <span class="n">results_arima</span><span class="o">.</span><span class="n">fittedvalues</span><span class="p">[</span><span class="n">n_missing</span><span class="p">:]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 75;
                var nbb_unformatted_code = "fittedvalues = results_arima.fittedvalues[n_missing:]";
                var nbb_formatted_code = "fittedvalues = results_arima.fittedvalues[n_missing:]";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>The fitted values are similar to the ones we computed, but not exactly the same – probably because <code class="docutils literal notranslate"><span class="pre">ARIMA</span></code> handles the initial conditions differently.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nuclear</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;actual&quot;</span><span class="p">)</span>
<span class="n">fittedvalues</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;0.9&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;ARIMA model&quot;</span><span class="p">)</span>
<span class="n">decorate</span><span class="p">(</span><span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;GWh&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/13cfdef6341a03ce98eb5f48d7e8f8ae260734e8a6fa9c09e269f7b3df02b655.png" src="_images/13cfdef6341a03ce98eb5f48d7e8f8ae260734e8a6fa9c09e269f7b3df02b655.png" />
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 76;
                var nbb_unformatted_code = "nuclear.plot(label=\"actual\")\nfittedvalues.plot(color=\"0.9\", label=\"ARIMA model\")\ndecorate(ylabel=\"GWh\")";
                var nbb_formatted_code = "nuclear.plot(label=\"actual\")\nfittedvalues.plot(color=\"0.9\", label=\"ARIMA model\")\ndecorate(ylabel=\"GWh\")";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>The <span class="math notranslate nohighlight">\(R^2\)</span> value is also similar but not precisely the same.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">resid</span> <span class="o">=</span> <span class="n">fittedvalues</span> <span class="o">-</span> <span class="n">nuclear</span>
<span class="n">R2</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">resid</span><span class="o">.</span><span class="n">var</span><span class="p">()</span> <span class="o">/</span> <span class="n">nuclear</span><span class="o">.</span><span class="n">var</span><span class="p">()</span>
<span class="n">R2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.8262717330784233
</pre></div>
</div>
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 77;
                var nbb_unformatted_code = "resid = fittedvalues - nuclear\nR2 = 1 - resid.var() / nuclear.var()\nR2";
                var nbb_formatted_code = "resid = fittedvalues - nuclear\nR2 = 1 - resid.var() / nuclear.var()\nR2";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">ARIMA</span></code> function makes it easy to experiment with different versions of the model.</p>
</section>
<section id="prediction-with-arima">
<h2><span class="section-number">12.9. </span>Prediction with ARIMA<a class="headerlink" href="#prediction-with-arima" title="Link to this heading">#</a></h2>
<p>The result from <code class="docutils literal notranslate"><span class="pre">ARIMA</span></code> provides a method called <code class="docutils literal notranslate"><span class="pre">get_forecast</span></code> that generates predictions.
To demonstrate, we’ll split the time series into a training and test set, and fit the same model to the training set.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">training</span><span class="p">,</span> <span class="n">test</span> <span class="o">=</span> <span class="n">split_series</span><span class="p">(</span><span class="n">nuclear</span><span class="p">)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">tsa</span><span class="o">.</span><span class="n">ARIMA</span><span class="p">(</span><span class="n">training</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">]),</span> <span class="n">seasonal_order</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>
<span class="n">results_training</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 78;
                var nbb_unformatted_code = "training, test = split_series(nuclear)\nmodel = tsa.ARIMA(training, order=(3, 0, [1, 6]), seasonal_order=(0, 1, 0, 12))\nresults_training = model.fit()";
                var nbb_formatted_code = "training, test = split_series(nuclear)\nmodel = tsa.ARIMA(training, order=(3, 0, [1, 6]), seasonal_order=(0, 1, 0, 12))\nresults_training = model.fit()";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>We can use the result to generate a forecast for the test set.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">forecast</span> <span class="o">=</span> <span class="n">results_training</span><span class="o">.</span><span class="n">get_forecast</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">test</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 79;
                var nbb_unformatted_code = "forecast = results_training.get_forecast(steps=len(test))";
                var nbb_formatted_code = "forecast = results_training.get_forecast(steps=len(test))";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>The result is an object that contains <code class="docutils literal notranslate"><span class="pre">forecast_mean</span></code> and a function that returns a confidence interval.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">forecast_mean</span> <span class="o">=</span> <span class="n">forecast</span><span class="o">.</span><span class="n">predicted_mean</span>
<span class="n">forecast_ci</span> <span class="o">=</span> <span class="n">forecast</span><span class="o">.</span><span class="n">conf_int</span><span class="p">()</span>
<span class="n">forecast_ci</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;lower&quot;</span><span class="p">,</span> <span class="s2">&quot;upper&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 80;
                var nbb_unformatted_code = "forecast_mean = forecast.predicted_mean\nforecast_ci = forecast.conf_int()\nforecast_ci.columns = [\"lower\", \"upper\"]";
                var nbb_formatted_code = "forecast_mean = forecast.predicted_mean\nforecast_ci = forecast.conf_int()\nforecast_ci.columns = [\"lower\", \"upper\"]";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>We can plot the result like this and compare them to the actual time series.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span>
    <span class="n">forecast_ci</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
    <span class="n">forecast_ci</span><span class="o">.</span><span class="n">lower</span><span class="p">,</span>
    <span class="n">forecast_ci</span><span class="o">.</span><span class="n">upper</span><span class="p">,</span>
    <span class="n">lw</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;0.6&quot;</span><span class="p">,</span>
    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">forecast_mean</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">forecast_mean</span><span class="p">,</span> <span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;forecast&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;0.6&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">test</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">test</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;actual&quot;</span><span class="p">)</span>
<span class="n">decorate</span><span class="p">(</span><span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;GWh&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/0b4671efbaa02fbba9dd66e5b25188176b49a95bad38e9a4721e8505421206d6.png" src="_images/0b4671efbaa02fbba9dd66e5b25188176b49a95bad38e9a4721e8505421206d6.png" />
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 81;
                var nbb_unformatted_code = "plt.fill_between(\n    forecast_ci.index,\n    forecast_ci.lower,\n    forecast_ci.upper,\n    lw=0,\n    color=\"0.6\",\n    alpha=0.2,\n)\nplt.plot(forecast_mean.index, forecast_mean, \"--\", label=\"forecast\", color=\"0.6\")\nplt.plot(test.index, test, label=\"actual\")\ndecorate(ylabel=\"GWh\")";
                var nbb_formatted_code = "plt.fill_between(\n    forecast_ci.index,\n    forecast_ci.lower,\n    forecast_ci.upper,\n    lw=0,\n    color=\"0.6\",\n    alpha=0.2,\n)\nplt.plot(forecast_mean.index, forecast_mean, \"--\", label=\"forecast\", color=\"0.6\")\nplt.plot(test.index, test, label=\"actual\")\ndecorate(ylabel=\"GWh\")";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>The actual values fall almost entirely within the confidence interval of the predictions.
Here’s the MAPE of the predictions.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">MAPE</span><span class="p">(</span><span class="n">forecast_mean</span><span class="p">,</span> <span class="n">test</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>3.381754924564627
</pre></div>
</div>
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 82;
                var nbb_unformatted_code = "MAPE(forecast_mean, test)";
                var nbb_formatted_code = "MAPE(forecast_mean, test)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>The predictions are off by 3.38% on average, somewhat better than the results we got from seasonal decomposition (3.81%).</p>
<p>ARIMA is more versatile than seasonal decomposition, and can often make better predictions.
In this time series, the autocorrelations are not especially strong, so the advantage of ARIMA is relatively small.</p>
</section>
<section id="glossary">
<h2><span class="section-number">12.10. </span>Glossary<a class="headerlink" href="#glossary" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p><strong>time series</strong>: A dataset where each value is associated with a timestamp, often a series of measurements and the times they were collected.</p></li>
<li><p><strong>window</strong>: A sequence of consecutive values in a time series, often used to compute a moving average.</p></li>
<li><p><strong>moving average</strong>: One of several statistics intended to estimate the underlying trend in a time series by computing averages (of some kind) for a series of overlapping windows.</p></li>
<li><p><strong>rolling mean</strong>: A moving average based on the mean value in each window.</p></li>
<li><p><strong>exponentially-weighted moving average (EWMA)</strong>: A moving average based on a weighted mean that gives the highest weight to the most recent values, and exponentially decreasing weights to earlier values.</p></li>
<li><p><strong>span</strong>: A parameter of EWMA that determines how quickly the weights decrease.</p></li>
<li><p><strong>serial correlation</strong>: Correlation between a time series and a shifted or lagged version of itself.</p></li>
<li><p><strong>lag</strong>: The size of the shift in a serial correlation or autocorrelation.</p></li>
<li><p><strong>autocorrelation</strong>: A more general term for a serial correlation with any amount of lag.</p></li>
<li><p><strong>autocorrelation function</strong>: A function that maps from lag to serial correlation.</p></li>
<li><p><strong>stationary</strong>: A model is stationary if the parameters and the distribution of residuals does not change over time.</p></li>
</ul>
</section>
<section id="exercises">
<h2><span class="section-number">12.11. </span>Exercises<a class="headerlink" href="#exercises" title="Link to this heading">#</a></h2>
<section id="exercise">
<h3><span class="section-number">12.11.1. </span>Exercise<a class="headerlink" href="#exercise" title="Link to this heading">#</a></h3>
<p>As an example of seasonal decomposition, let’s model monthly average surface temperatures in the United States.
We’ll use a dataset from Our World in Data that includes “temperature [in Celsius] of the air measured 2 meters above the ground, encompassing land, sea, and in-land water surfaces,” for most countries in the world from 1950 to 2024.
Instructions for downloading the data are in the notebook for this chapter.</p>
<div class="cell tag_remove-print docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># The following cell downloads data prepared by Our World in Data,</span>
<span class="c1"># which I Downloaded September 18, 2024</span>
<span class="c1"># from https://ourworldindata.org/grapher/average-monthly-surface-temperature</span>

<span class="c1"># Based on modified data from Copernicus Climate Change Service information (2019)</span>
<span class="c1"># with &quot;major processing&quot; by Our World in Data</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 83;
                var nbb_unformatted_code = "# The following cell downloads data prepared by Our World in Data,\n# which I Downloaded September 18, 2024\n# from https://ourworldindata.org/grapher/average-monthly-surface-temperature\n\n# Based on modified data from Copernicus Climate Change Service information (2019)\n# with \"major processing\" by Our World in Data";
                var nbb_formatted_code = "# The following cell downloads data prepared by Our World in Data,\n# which I Downloaded September 18, 2024\n# from https://ourworldindata.org/grapher/average-monthly-surface-temperature\n\n# Based on modified data from Copernicus Climate Change Service information (2019)\n# with \"major processing\" by Our World in Data";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<div class="cell tag_remove-print docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;monthly-average-surface-temperatures-by-year.csv&quot;</span>
<span class="n">download</span><span class="p">(</span><span class="s2">&quot;https://github.com/AllenDowney/ThinkStats/raw/v3/data/&quot;</span> <span class="o">+</span> <span class="n">filename</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 84;
                var nbb_unformatted_code = "filename = \"monthly-average-surface-temperatures-by-year.csv\"\ndownload(\"https://github.com/AllenDowney/ThinkStats/raw/v3/data/\" + filename)";
                var nbb_formatted_code = "filename = \"monthly-average-surface-temperatures-by-year.csv\"\ndownload(\"https://github.com/AllenDowney/ThinkStats/raw/v3/data/\" + filename)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>We can read the data like this.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">temp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;monthly-average-surface-temperatures-by-year.csv&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 85;
                var nbb_unformatted_code = "temp = pd.read_csv(\"monthly-average-surface-temperatures-by-year.csv\")";
                var nbb_formatted_code = "temp = pd.read_csv(\"monthly-average-surface-temperatures-by-year.csv\")";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<div class="cell tag_remove-print docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">temp</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Entity</th>
      <th>Code</th>
      <th>Year</th>
      <th>2024</th>
      <th>2023</th>
      <th>2022</th>
      <th>2021</th>
      <th>2020</th>
      <th>2019</th>
      <th>2018</th>
      <th>...</th>
      <th>1959</th>
      <th>1958</th>
      <th>1956</th>
      <th>1954</th>
      <th>1952</th>
      <th>1957</th>
      <th>1955</th>
      <th>1953</th>
      <th>1951</th>
      <th>1950</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Afghanistan</td>
      <td>AFG</td>
      <td>1</td>
      <td>3.300064</td>
      <td>-4.335608</td>
      <td>-0.322859</td>
      <td>-1.001608</td>
      <td>-2.560545</td>
      <td>0.585145</td>
      <td>1.042471</td>
      <td>...</td>
      <td>-2.333814</td>
      <td>0.576404</td>
      <td>-3.351925</td>
      <td>-2.276692</td>
      <td>-2.812619</td>
      <td>-4.239172</td>
      <td>-2.191683</td>
      <td>-2.915993</td>
      <td>-3.126317</td>
      <td>-2.655707</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Afghanistan</td>
      <td>AFG</td>
      <td>2</td>
      <td>1.024550</td>
      <td>4.187041</td>
      <td>2.165870</td>
      <td>5.688000</td>
      <td>2.880046</td>
      <td>0.068664</td>
      <td>3.622793</td>
      <td>...</td>
      <td>-1.545529</td>
      <td>0.264962</td>
      <td>0.455350</td>
      <td>-0.304205</td>
      <td>0.798226</td>
      <td>-2.747945</td>
      <td>1.999074</td>
      <td>1.983414</td>
      <td>-2.642800</td>
      <td>-3.996040</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Afghanistan</td>
      <td>AFG</td>
      <td>3</td>
      <td>5.843506</td>
      <td>10.105444</td>
      <td>10.483686</td>
      <td>9.777976</td>
      <td>6.916731</td>
      <td>5.758049</td>
      <td>10.794412</td>
      <td>...</td>
      <td>5.942937</td>
      <td>7.716459</td>
      <td>5.090270</td>
      <td>4.357703</td>
      <td>4.796146</td>
      <td>4.434027</td>
      <td>7.066073</td>
      <td>4.590406</td>
      <td>3.054388</td>
      <td>3.491112</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Afghanistan</td>
      <td>AFG</td>
      <td>4</td>
      <td>11.627398</td>
      <td>14.277164</td>
      <td>17.227650</td>
      <td>15.168276</td>
      <td>12.686832</td>
      <td>13.838840</td>
      <td>14.321226</td>
      <td>...</td>
      <td>13.752827</td>
      <td>14.712909</td>
      <td>11.982360</td>
      <td>12.155265</td>
      <td>13.119270</td>
      <td>8.263829</td>
      <td>10.418768</td>
      <td>11.087193</td>
      <td>9.682878</td>
      <td>8.332797</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Afghanistan</td>
      <td>AFG</td>
      <td>5</td>
      <td>18.957850</td>
      <td>19.078170</td>
      <td>19.962734</td>
      <td>19.885902</td>
      <td>18.884047</td>
      <td>18.461287</td>
      <td>18.100782</td>
      <td>...</td>
      <td>17.388723</td>
      <td>16.352045</td>
      <td>20.125462</td>
      <td>18.432117</td>
      <td>17.614851</td>
      <td>15.505956</td>
      <td>15.599709</td>
      <td>17.865084</td>
      <td>17.095737</td>
      <td>17.329062</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 78 columns</p>
</div></div><script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 86;
                var nbb_unformatted_code = "temp.head()";
                var nbb_formatted_code = "temp.head()";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>The following cell selects data for the United States from 2001 to the end of the series and packs it into a Pandas <code class="docutils literal notranslate"><span class="pre">Series</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">temp_us</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Code == &#39;USA&#39;&quot;</span><span class="p">)</span>
<span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">)</span> <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="mi">2025</span><span class="p">)]</span>
<span class="n">temp_series</span> <span class="o">=</span> <span class="n">temp_us</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">columns</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span><span class="o">.</span><span class="n">stack</span><span class="p">()</span>
<span class="n">temp_series</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="s2">&quot;2000-01&quot;</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">temp_series</span><span class="p">),</span> <span class="n">freq</span><span class="o">=</span><span class="s2">&quot;M&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/tmp/ipykernel_851943/704380127.py:4: FutureWarning: &#39;M&#39; is deprecated and will be removed in a future version, please use &#39;ME&#39; instead.
  temp_series.index = pd.date_range(start=&quot;2000-01&quot;, periods=len(temp_series), freq=&quot;M&quot;)
</pre></div>
</div>
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 87;
                var nbb_unformatted_code = "temp_us = temp.query(\"Code == 'USA'\")\ncolumns = [str(year) for year in range(2000, 2025)]\ntemp_series = temp_us.loc[:, columns].transpose().stack()\ntemp_series.index = pd.date_range(start=\"2000-01\", periods=len(temp_series), freq=\"M\")";
                var nbb_formatted_code = "temp_us = temp.query(\"Code == 'USA'\")\ncolumns = [str(year) for year in range(2000, 2025)]\ntemp_series = temp_us.loc[:, columns].transpose().stack()\ntemp_series.index = pd.date_range(start=\"2000-01\", periods=len(temp_series), freq=\"M\")";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>Here’s what it looks like.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">temp_series</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;monthly average&quot;</span><span class="p">)</span>
<span class="n">decorate</span><span class="p">(</span><span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;Surface temperature (degC)&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/928fdbaea989eb0339674589b1980ee6efd86a33fb1ea37e3942d64ae8eca416.png" src="_images/928fdbaea989eb0339674589b1980ee6efd86a33fb1ea37e3942d64ae8eca416.png" />
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 88;
                var nbb_unformatted_code = "temp_series.plot(label=\"monthly average\")\ndecorate(ylabel=\"Surface temperature (degC)\")";
                var nbb_formatted_code = "temp_series.plot(label=\"monthly average\")\ndecorate(ylabel=\"Surface temperature (degC)\")";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>Not surprisingly, there is a strong seasonal pattern.
Compute an additive seasonal decomposition with a period of 12 months.
Fit a linear model to the trend line.
What is the average annual increase in surface temperature during this interval?
If you are curious, repeat this analysis with other intervals or data from other countries.</p>
</section>
</section>
<section id="id1">
<h2><span class="section-number">12.12. </span>Exercise<a class="headerlink" href="#id1" title="Link to this heading">#</a></h2>
<p>Earlier in this chapter we used a multiplicative seasonal decomposition to model electricity production from small-scale solar power from 2014 to 2019 and forecast production from 2019 to 2024.
As an exercise, let’s do the same with utility-scale solar power.
Here’s what the time series looks like.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">util_solar</span> <span class="o">=</span> <span class="n">elec</span><span class="p">[</span><span class="s2">&quot;United States : all utility-scale solar&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
<span class="n">util_solar</span> <span class="o">=</span> <span class="n">util_solar</span><span class="p">[</span><span class="n">util_solar</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">&gt;=</span> <span class="mi">2014</span><span class="p">]</span>
<span class="n">util_solar</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">decorate</span><span class="p">(</span><span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;GWh&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/95e24f9fb74b55d01762624ced9c3b3c820ed1d9b56871b899fbd78c5daf7435.png" src="_images/95e24f9fb74b55d01762624ced9c3b3c820ed1d9b56871b899fbd78c5daf7435.png" />
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 98;
                var nbb_unformatted_code = "util_solar = elec[\"United States : all utility-scale solar\"].dropna()\nutil_solar = util_solar[util_solar.index.year >= 2014]\nutil_solar.plot()\ndecorate(ylabel=\"GWh\")";
                var nbb_formatted_code = "util_solar = elec[\"United States : all utility-scale solar\"].dropna()\nutil_solar = util_solar[util_solar.index.year >= 2014]\nutil_solar.plot()\ndecorate(ylabel=\"GWh\")";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>Use <code class="docutils literal notranslate"><span class="pre">split_series</span></code> to split this data into a training and test series.
Compute a multiplicative decomposition of the training series with a 12-month period.
Fit a linear or quadratic model to the trend and generate a five-year forecast, including a seasonal component.
Plot the forecast along with the test series, and compute the mean absolute percentage error (MAPE).</p>
</section>
<section id="id2">
<h2><span class="section-number">12.13. </span>Exercise<a class="headerlink" href="#id2" title="Link to this heading">#</a></h2>
<p>Let’s see how well an ARIMA model fits production from hydroelectric generators in the United States.
Here’s what the time series looks like from 2001 to 2024.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hydro</span> <span class="o">=</span> <span class="n">elec</span><span class="p">[</span><span class="s2">&quot;United States : conventional hydroelectric&quot;</span><span class="p">]</span>
<span class="n">hydro</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">decorate</span><span class="p">(</span><span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;GWh&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/e685ca8ae92ec5b24c6602c6a23ed5f3838503178d847191b434dee90bbda12e.png" src="_images/e685ca8ae92ec5b24c6602c6a23ed5f3838503178d847191b434dee90bbda12e.png" />
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 108;
                var nbb_unformatted_code = "hydro = elec[\"United States : conventional hydroelectric\"]\nhydro.plot()\ndecorate(ylabel=\"GWh\")";
                var nbb_formatted_code = "hydro = elec[\"United States : conventional hydroelectric\"]\nhydro.plot()\ndecorate(ylabel=\"GWh\")";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>Fit a SARIMA model to this data with a seasonal period of 12 months.
Experiment with different lags in the autoregression and moving average parts of the model and see if you can find a combination that maximizes the <span class="math notranslate nohighlight">\(R^2\)</span> value of the model.
Generate a five-year forecast and plot it along with its confidence interval.</p>
<p>NOTE: Depending on what lags you include in the model, you might find that the first 12 to 24 elements of the fitted values are not reliable. You might want to remove them before plotting or computing <span class="math notranslate nohighlight">\(R^2\)</span>.</p>
<p><a class="reference external" href="https://allendowney.github.io/ThinkStats/index.html">Think Stats: Exploratory Data Analysis in Python, 3rd Edition</a></p>
<p>Copyright 2024 <a class="reference external" href="https://allendowney.com">Allen B. Downey</a></p>
<p>Code license: <a class="reference external" href="https://mit-license.org/">MIT License</a></p>
<p>Text license: <a class="reference external" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International</a></p>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="chap11.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title"><span class="section-number">11. </span>Regression</p>
      </div>
    </a>
    <a class="right-next"
       href="chap13.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title"><span class="section-number">13. </span>Survival analysis</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#electricity">12.1. Electricity</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#decomposition">12.2. Decomposition</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#prediction">12.3. Prediction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#multiplicative-model">12.4. Multiplicative Model</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#autoregression">12.5. Autoregression</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#moving-average">12.6. Moving Average</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#retrodiction-with-autoregression">12.7. Retrodiction with Autoregression</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#arima">12.8. ARIMA</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#prediction-with-arima">12.9. Prediction with ARIMA</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#glossary">12.10. Glossary</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercises">12.11. Exercises</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise">12.11.1. Exercise</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">12.12. Exercise</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">12.13. Exercise</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Allen B. Downey
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
<div class="extra_footer">
  <div style="text-align: left;">
  <a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">
    <img alt="Creative Commons License" style="border-width:0"
         src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" />
  </a>
  <br />
  This work is licensed under a
  <a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">
    Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License
  </a>.
</div>

</div>
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=3ee479438cf8b5e0d341"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=3ee479438cf8b5e0d341"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>